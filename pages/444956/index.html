<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis优化 | 凉冰的手记</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/192.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#2196f3">
    <meta name="description" content="记录生活的精彩瞬间，记录一个程序猿的成长！">
    <meta name="keywords" content="琐事，小记">
    <meta name="author" href="凉冰">
    <meta name="theme-color" content="#2196f3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.59ed400b.css" as="style"><link rel="preload" href="/assets/js/app.3ee2b30c.js" as="script"><link rel="preload" href="/assets/js/2.fc657b59.js" as="script"><link rel="preload" href="/assets/js/53.8347b740.js" as="script"><link rel="preload" href="/assets/js/3.e0ec9727.js" as="script"><link rel="prefetch" href="/assets/js/10.eb4f1714.js"><link rel="prefetch" href="/assets/js/100.60572966.js"><link rel="prefetch" href="/assets/js/101.d94775a6.js"><link rel="prefetch" href="/assets/js/102.354c87f2.js"><link rel="prefetch" href="/assets/js/103.0322d8d3.js"><link rel="prefetch" href="/assets/js/104.330ce470.js"><link rel="prefetch" href="/assets/js/105.f2c0cf7b.js"><link rel="prefetch" href="/assets/js/106.9b15e481.js"><link rel="prefetch" href="/assets/js/107.f83846c8.js"><link rel="prefetch" href="/assets/js/108.fd868043.js"><link rel="prefetch" href="/assets/js/109.144984d2.js"><link rel="prefetch" href="/assets/js/11.1f4ed2b0.js"><link rel="prefetch" href="/assets/js/110.393075aa.js"><link rel="prefetch" href="/assets/js/111.8e2be411.js"><link rel="prefetch" href="/assets/js/112.f5db1301.js"><link rel="prefetch" href="/assets/js/113.c5a49956.js"><link rel="prefetch" href="/assets/js/114.f7400c29.js"><link rel="prefetch" href="/assets/js/115.0d4d9691.js"><link rel="prefetch" href="/assets/js/116.5e2d0bba.js"><link rel="prefetch" href="/assets/js/117.b9b6cd5c.js"><link rel="prefetch" href="/assets/js/118.cfffe6ca.js"><link rel="prefetch" href="/assets/js/119.faeb006b.js"><link rel="prefetch" href="/assets/js/12.c55c2945.js"><link rel="prefetch" href="/assets/js/120.2c87041a.js"><link rel="prefetch" href="/assets/js/121.6d6d525b.js"><link rel="prefetch" href="/assets/js/122.a378a709.js"><link rel="prefetch" href="/assets/js/123.8a44d7e0.js"><link rel="prefetch" href="/assets/js/124.eef03f70.js"><link rel="prefetch" href="/assets/js/125.20627b3b.js"><link rel="prefetch" href="/assets/js/126.02bdd70b.js"><link rel="prefetch" href="/assets/js/127.6aaf85c7.js"><link rel="prefetch" href="/assets/js/128.2f2f6b78.js"><link rel="prefetch" href="/assets/js/129.b1f7d667.js"><link rel="prefetch" href="/assets/js/13.b5382928.js"><link rel="prefetch" href="/assets/js/130.aadb5b72.js"><link rel="prefetch" href="/assets/js/131.0a0ad3b4.js"><link rel="prefetch" href="/assets/js/132.a05a0c00.js"><link rel="prefetch" href="/assets/js/133.584b8785.js"><link rel="prefetch" href="/assets/js/134.ab61764f.js"><link rel="prefetch" href="/assets/js/135.ccae4853.js"><link rel="prefetch" href="/assets/js/136.38fdaa61.js"><link rel="prefetch" href="/assets/js/137.502d74c0.js"><link rel="prefetch" href="/assets/js/138.12a12ee7.js"><link rel="prefetch" href="/assets/js/139.5ed042c0.js"><link rel="prefetch" href="/assets/js/14.9bf49d25.js"><link rel="prefetch" href="/assets/js/140.32ffb0bc.js"><link rel="prefetch" href="/assets/js/141.3b99bc3f.js"><link rel="prefetch" href="/assets/js/142.afd3e1e7.js"><link rel="prefetch" href="/assets/js/143.ad7b5934.js"><link rel="prefetch" href="/assets/js/144.7bdbdbd9.js"><link rel="prefetch" href="/assets/js/145.3f68756b.js"><link rel="prefetch" href="/assets/js/146.a48f80c3.js"><link rel="prefetch" href="/assets/js/147.eb3a30a3.js"><link rel="prefetch" href="/assets/js/148.563f4279.js"><link rel="prefetch" href="/assets/js/149.7627333e.js"><link rel="prefetch" href="/assets/js/15.47e2fe44.js"><link rel="prefetch" href="/assets/js/150.7cf4b6fd.js"><link rel="prefetch" href="/assets/js/151.200e2d36.js"><link rel="prefetch" href="/assets/js/152.68d5a6f8.js"><link rel="prefetch" href="/assets/js/153.4019d1b1.js"><link rel="prefetch" href="/assets/js/154.7c56b873.js"><link rel="prefetch" href="/assets/js/155.8a895428.js"><link rel="prefetch" href="/assets/js/156.9a106f9c.js"><link rel="prefetch" href="/assets/js/157.b585e3f5.js"><link rel="prefetch" href="/assets/js/158.a9ffbcc1.js"><link rel="prefetch" href="/assets/js/159.9bd41101.js"><link rel="prefetch" href="/assets/js/16.709e62a0.js"><link rel="prefetch" href="/assets/js/17.b149e3eb.js"><link rel="prefetch" href="/assets/js/18.5b57a250.js"><link rel="prefetch" href="/assets/js/19.d2aedd09.js"><link rel="prefetch" href="/assets/js/20.13fd637f.js"><link rel="prefetch" href="/assets/js/21.91dc71fa.js"><link rel="prefetch" href="/assets/js/22.b44ebaaf.js"><link rel="prefetch" href="/assets/js/23.85274bf7.js"><link rel="prefetch" href="/assets/js/24.fdcf9dad.js"><link rel="prefetch" href="/assets/js/25.d7834455.js"><link rel="prefetch" href="/assets/js/26.149bb0bb.js"><link rel="prefetch" href="/assets/js/27.fe47c303.js"><link rel="prefetch" href="/assets/js/28.106a053b.js"><link rel="prefetch" href="/assets/js/29.5cbd445a.js"><link rel="prefetch" href="/assets/js/30.bc8be6db.js"><link rel="prefetch" href="/assets/js/31.776bb22e.js"><link rel="prefetch" href="/assets/js/32.38f1617c.js"><link rel="prefetch" href="/assets/js/33.764d5e8e.js"><link rel="prefetch" href="/assets/js/34.ee4b3664.js"><link rel="prefetch" href="/assets/js/35.0c8a4552.js"><link rel="prefetch" href="/assets/js/36.3114f265.js"><link rel="prefetch" href="/assets/js/37.6623c809.js"><link rel="prefetch" href="/assets/js/38.47b2ae3c.js"><link rel="prefetch" href="/assets/js/39.66477360.js"><link rel="prefetch" href="/assets/js/4.7bd8ec5a.js"><link rel="prefetch" href="/assets/js/40.3c1369b3.js"><link rel="prefetch" href="/assets/js/41.ba422769.js"><link rel="prefetch" href="/assets/js/42.d8feaaee.js"><link rel="prefetch" href="/assets/js/43.7a023784.js"><link rel="prefetch" href="/assets/js/44.578065d4.js"><link rel="prefetch" href="/assets/js/45.599d10a9.js"><link rel="prefetch" href="/assets/js/46.68c58a57.js"><link rel="prefetch" href="/assets/js/47.a0e48134.js"><link rel="prefetch" href="/assets/js/48.a8edc4f3.js"><link rel="prefetch" href="/assets/js/49.a98d9884.js"><link rel="prefetch" href="/assets/js/5.bc317ee9.js"><link rel="prefetch" href="/assets/js/50.7001c5b8.js"><link rel="prefetch" href="/assets/js/51.43d17700.js"><link rel="prefetch" href="/assets/js/52.9ad031a9.js"><link rel="prefetch" href="/assets/js/54.73a1db12.js"><link rel="prefetch" href="/assets/js/55.06ac4334.js"><link rel="prefetch" href="/assets/js/56.caf42a7a.js"><link rel="prefetch" href="/assets/js/57.c8af04ff.js"><link rel="prefetch" href="/assets/js/58.259c0df6.js"><link rel="prefetch" href="/assets/js/59.4a73da6e.js"><link rel="prefetch" href="/assets/js/6.da0024ba.js"><link rel="prefetch" href="/assets/js/60.c88072d5.js"><link rel="prefetch" href="/assets/js/61.a3a06ae4.js"><link rel="prefetch" href="/assets/js/62.e5adc7b0.js"><link rel="prefetch" href="/assets/js/63.48cc1305.js"><link rel="prefetch" href="/assets/js/64.86f8647c.js"><link rel="prefetch" href="/assets/js/65.005e380e.js"><link rel="prefetch" href="/assets/js/66.67bff065.js"><link rel="prefetch" href="/assets/js/67.e12b4c13.js"><link rel="prefetch" href="/assets/js/68.0161e8c6.js"><link rel="prefetch" href="/assets/js/69.5aaf7b82.js"><link rel="prefetch" href="/assets/js/7.1d00dc1d.js"><link rel="prefetch" href="/assets/js/70.6a645155.js"><link rel="prefetch" href="/assets/js/71.001a3225.js"><link rel="prefetch" href="/assets/js/72.2850a293.js"><link rel="prefetch" href="/assets/js/73.d250e0c6.js"><link rel="prefetch" href="/assets/js/74.dafa5bc3.js"><link rel="prefetch" href="/assets/js/75.22c6b92e.js"><link rel="prefetch" href="/assets/js/76.24bc0a51.js"><link rel="prefetch" href="/assets/js/77.e38213b8.js"><link rel="prefetch" href="/assets/js/78.a22de10e.js"><link rel="prefetch" href="/assets/js/79.b0e7fed2.js"><link rel="prefetch" href="/assets/js/8.b16448cb.js"><link rel="prefetch" href="/assets/js/80.67472401.js"><link rel="prefetch" href="/assets/js/81.1df69f3e.js"><link rel="prefetch" href="/assets/js/82.022c9317.js"><link rel="prefetch" href="/assets/js/83.8894e626.js"><link rel="prefetch" href="/assets/js/84.e9f038d8.js"><link rel="prefetch" href="/assets/js/85.ff3971f7.js"><link rel="prefetch" href="/assets/js/86.24e53411.js"><link rel="prefetch" href="/assets/js/87.95b56dc2.js"><link rel="prefetch" href="/assets/js/88.4557cc7d.js"><link rel="prefetch" href="/assets/js/89.1337890b.js"><link rel="prefetch" href="/assets/js/9.1b8d4154.js"><link rel="prefetch" href="/assets/js/90.29d24983.js"><link rel="prefetch" href="/assets/js/91.84b2e3eb.js"><link rel="prefetch" href="/assets/js/92.23e2abeb.js"><link rel="prefetch" href="/assets/js/93.162e9b76.js"><link rel="prefetch" href="/assets/js/94.9ada79ba.js"><link rel="prefetch" href="/assets/js/95.5cc24e13.js"><link rel="prefetch" href="/assets/js/96.0ee67f9e.js"><link rel="prefetch" href="/assets/js/97.9f98bf38.js"><link rel="prefetch" href="/assets/js/98.58600000.js"><link rel="prefetch" href="/assets/js/99.f8a36889.js">
    <link rel="stylesheet" href="/assets/css/0.styles.59ed400b.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/恶魔.webp" alt="凉冰的手记" class="logo"> <span class="site-name can-hide">凉冰的手记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><a href="/Java-C/" class="link-title">后端</a> <span class="title" style="display:none;">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/back/java/" class="nav-link">Java</a></li><li class="dropdown-item"><!----> <a href="/back/javaWeb/" class="nav-link">JavaWeb</a></li><li class="dropdown-item"><!----> <a href="/back/sql/" class="nav-link">数据库</a></li><li class="dropdown-item"><!----> <a href="/back/SSM/" class="nav-link">SSM</a></li><li class="dropdown-item"><!----> <a href="/back/SpringBoot/" class="nav-link">SpringBoot</a></li><li class="dropdown-item"><!----> <a href="/back/Microservice/" class="nav-link">微服务</a></li></ul></div></div><div class="nav-item"><a href="/Algorithm/" class="nav-link">算法</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/technology/Git/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/technology/Linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/pages/b5d182/" class="nav-link">正则表达式</a></li></ul></div></div><div class="nav-item"><a href="/pages/edb686/" class="nav-link">面试</a></div><div class="nav-item"><a href="/pages/2aa63b/" class="nav-link">项目记录</a></div><div class="nav-item"><a href="/pages/1b70fb/" class="nav-link">DOA</a></div><div class="nav-item"><a href="/pages/d591da/" class="nav-link">精彩瞬间</a></div><div class="nav-item"><a href="/pages/961a83/" class="nav-link">任意门</a></div><div class="nav-item"><a href="https://github.com/diana-devil/diana-devil.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/devil.jpg"> <div class="blogger-info"><h3>凉冰</h3> <span>奋勇向前的可爱小恶魔！</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><a href="/Java-C/" class="link-title">后端</a> <span class="title" style="display:none;">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/back/java/" class="nav-link">Java</a></li><li class="dropdown-item"><!----> <a href="/back/javaWeb/" class="nav-link">JavaWeb</a></li><li class="dropdown-item"><!----> <a href="/back/sql/" class="nav-link">数据库</a></li><li class="dropdown-item"><!----> <a href="/back/SSM/" class="nav-link">SSM</a></li><li class="dropdown-item"><!----> <a href="/back/SpringBoot/" class="nav-link">SpringBoot</a></li><li class="dropdown-item"><!----> <a href="/back/Microservice/" class="nav-link">微服务</a></li></ul></div></div><div class="nav-item"><a href="/Algorithm/" class="nav-link">算法</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/technology/Git/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/technology/Linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/pages/b5d182/" class="nav-link">正则表达式</a></li></ul></div></div><div class="nav-item"><a href="/pages/edb686/" class="nav-link">面试</a></div><div class="nav-item"><a href="/pages/2aa63b/" class="nav-link">项目记录</a></div><div class="nav-item"><a href="/pages/1b70fb/" class="nav-link">DOA</a></div><div class="nav-item"><a href="/pages/d591da/" class="nav-link">精彩瞬间</a></div><div class="nav-item"><a href="/pages/961a83/" class="nav-link">任意门</a></div><div class="nav-item"><a href="https://github.com/diana-devil/diana-devil.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaWeb</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>数据库</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>MySQL</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Redis</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/31e22b/" class="sidebar-link">Redis基础</a></li><li><a href="/pages/948263/" class="sidebar-link">Redis常见命令</a></li><li><a href="/pages/94a219/" class="sidebar-link">RedisAPI</a></li><li><a href="/pages/444956/" aria-current="page" class="active sidebar-link">Redis优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/444956/#redis键值设计" class="sidebar-link">Redis键值设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/444956/#优雅的key结构" class="sidebar-link">优雅的key结构</a></li><li class="sidebar-sub-header level3"><a href="/pages/444956/#拒绝bigkey" class="sidebar-link">拒绝BigKey</a></li><li class="sidebar-sub-header level3"><a href="/pages/444956/#恰当的数据类型" class="sidebar-link">恰当的数据类型</a></li><li class="sidebar-sub-header level3"><a href="/pages/444956/#总结" class="sidebar-link">总结</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/444956/#批处理优化" class="sidebar-link">批处理优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/444956/#pipeline" class="sidebar-link">Pipeline</a></li><li class="sidebar-sub-header level3"><a href="/pages/444956/#集群下的批处理" class="sidebar-link">集群下的批处理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/444956/#服务器端优化-持久化配置" class="sidebar-link">服务器端优化-持久化配置</a></li><li class="sidebar-sub-header level2"><a href="/pages/444956/#服务器端优化-慢查询优化" class="sidebar-link">服务器端优化-慢查询优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/444956/#什么是慢查询" class="sidebar-link">什么是慢查询</a></li><li class="sidebar-sub-header level3"><a href="/pages/444956/#如何查看慢查询" class="sidebar-link">如何查看慢查询</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/444956/#服务器端优化-命令及安全配置" class="sidebar-link">服务器端优化-命令及安全配置</a></li><li class="sidebar-sub-header level2"><a href="/pages/444956/#服务器端优化-redis内存划分和内存配置" class="sidebar-link">服务器端优化-Redis内存划分和内存配置</a></li><li class="sidebar-sub-header level2"><a href="/pages/444956/#服务器端集群优化-集群还是主从" class="sidebar-link">服务器端集群优化-集群还是主从</a></li></ul></li><li><a href="/pages/7c7a2d/" class="sidebar-link">Redis持久化</a></li><li><a href="/pages/ef6419/" class="sidebar-link">Redis主从</a></li><li><a href="/pages/74c463/" class="sidebar-link">Redis哨兵</a></li><li><a href="/pages/f86562/" class="sidebar-link">Redis分片集群</a></li><li><a href="/pages/981287/" class="sidebar-link">分布式缓存总结</a></li><li><a href="/pages/a0085d/" class="sidebar-link">Redis数据结构</a></li><li><a href="/pages/11137c/" class="sidebar-link">Redis通信协议</a></li><li><a href="/pages/638026/" class="sidebar-link">Redis网络模型</a></li><li><a href="/pages/11b084/" class="sidebar-link">Redis内存回收</a></li><li><a href="/pages/2d9387/" class="sidebar-link">单机安装Redis</a></li><li><a href="/pages/564491/" class="sidebar-link">主从集群搭建</a></li><li><a href="/pages/ca02f2/" class="sidebar-link">哨兵集群搭建</a></li><li><a href="/pages/fdb88d/" class="sidebar-link">分片集群搭建</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SSM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringBoot</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E5%90%8E%E7%AB%AF" title="分类" data-v-06225672>后端</a></li><li data-v-06225672><a href="/categories/?category=%E6%95%B0%E6%8D%AE%E5%BA%93" title="分类" data-v-06225672>数据库</a></li><li data-v-06225672><a href="/categories/?category=Redis" title="分类" data-v-06225672>Redis</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/diana-devil" target="_blank" title="作者" class="beLink" data-v-06225672>凉冰</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-06-30</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Redis优化<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="redis键值设计"><a href="#redis键值设计" class="header-anchor">#</a> Redis键值设计</h2> <h3 id="优雅的key结构"><a href="#优雅的key结构" class="header-anchor">#</a> 优雅的key结构</h3> <p>Redis的Key虽然可以自定义，但最好遵循下面的几个最佳实践约定：</p> <ul><li>遵循基本格式：[业务名称]:[数据名]:[id]</li> <li>长度不超过44字节</li> <li>不包含特殊字符</li></ul> <p>例如：我们的登录业务，保存用户信息，其key可以设计成如下格式：</p> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20220521120213631.png" alt="image-20220521120213631"></p> <p>这样设计的好处：</p> <ul><li>可读性强</li> <li>避免key冲突</li> <li>方便管理</li> <li>更节省内存： key是string类型，底层编码包含int、embstr和raw三种。embstr在小于44字节使用，采用连续内存空间，内存占用更小。当字节数大于44字节时，会转为raw模式存储，在raw模式下，内存空间不是连续的，而是采用一个指针指向了另外一段内存空间，在这段空间里存储SDS内容，这样空间不连续，访问的时候性能也就会收到影响，还有可能产生内存碎片</li></ul> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20220521122320482.png" alt="image-20220521122320482"></p> <h3 id="拒绝bigkey"><a href="#拒绝bigkey" class="header-anchor">#</a> 拒绝BigKey</h3> <p>BigKey通常以Key的大小和Key中成员的数量来综合判定，例如：</p> <ul><li>Key本身的数据量过大：一个String类型的Key，它的值为5 MB</li> <li>Key中的成员数过多：一个ZSET类型的Key，它的成员数量为10,000个</li> <li>Key中成员的数据量过大：一个Hash类型的Key，它的成员数量虽然只有1,000个但这些成员的Value（值）总大小为100 MB</li></ul> <p>那么如何判断元素的大小呢？redis也给我们提供了命令</p> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20220521124650117.png" alt="image-20220521124650117"></p> <p>推荐值：</p> <ul><li>单个key的value小于10KB</li> <li>对于集合类型的key，建议元素数量小于1000</li></ul> <h4 id="bigkey的危害"><a href="#bigkey的危害" class="header-anchor">#</a> BigKey的危害</h4> <ul><li>网络阻塞
<ul><li>对BigKey执行读请求时，少量的QPS就可能导致带宽使用率被占满，导致Redis实例，乃至所在物理机变慢</li></ul></li> <li>数据倾斜
<ul><li>BigKey所在的Redis实例内存使用率远超其他实例，无法使数据分片的内存资源达到均衡</li></ul></li> <li>Redis阻塞
<ul><li>对元素较多的hash、list、zset等做运算会耗时较旧，使主线程被阻塞</li></ul></li> <li>CPU压力
<ul><li>对BigKey的数据序列化和反序列化会导致CPU的使用率飙升，影响Redis实例和本机其它应用</li></ul></li></ul> <h4 id="如何发现bigkey"><a href="#如何发现bigkey" class="header-anchor">#</a> 如何发现BigKey</h4> <h5 id="_1redis-cli-bigkeys"><a href="#_1redis-cli-bigkeys" class="header-anchor">#</a> ①redis-cli --bigkeys</h5> <p>利用redis-cli提供的--bigkeys参数，可以遍历分析所有key，并返回Key的整体统计信息与每个数据的Top1的big key</p> <p>命令：<code>redis-cli -a 密码 --bigkeys</code></p> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20220521133359507.png" alt="image-20220521133359507"></p> <h5 id="_2scan扫描"><a href="#_2scan扫描" class="header-anchor">#</a> ②scan扫描</h5> <p>自己编程，利用scan扫描Redis中的所有key，利用strlen、hlen等命令判断key的长度（此处不建议使用MEMORY USAGE）</p> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20220521133703245.png" alt="image-20220521133703245"></p> <p>scan 命令调用完后每次会返回2个元素，第一个是下一次迭代的光标，第一次光标会设置为0，当最后一次scan 返回的光标等于0时，表示整个scan遍历结束了，第二个返回的是List，一个匹配的key的数组</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">JedisConnectionFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">AfterEach</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">BeforeEach</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span><span class="token class-name">Jedis</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span><span class="token class-name">ScanResult</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Jedis</span> jedis<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.建立连接</span>
        <span class="token comment">// jedis = new Jedis(&quot;192.168.150.101&quot;, 6379);</span>
        jedis <span class="token operator">=</span> <span class="token class-name">JedisConnectionFactory</span><span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.设置密码</span>
        jedis<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">&quot;123321&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.选择库</span>
        jedis<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">STR_MAX_LEN</span> <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">HASH_MAX_LEN</span> <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> maxLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> cursor <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token comment">// 扫描并获取一部分key</span>
            <span class="token class-name">ScanResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 记录cursor</span>
            cursor <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 遍历</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 判断key的类型</span>
                <span class="token class-name">String</span> type <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;string&quot;</span><span class="token operator">:</span>
                        len <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">strlen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        maxLen <span class="token operator">=</span> <span class="token constant">STR_MAX_LEN</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;hash&quot;</span><span class="token operator">:</span>
                        len <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">hlen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        maxLen <span class="token operator">=</span> <span class="token constant">HASH_MAX_LEN</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;list&quot;</span><span class="token operator">:</span>
                        len <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">llen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        maxLen <span class="token operator">=</span> <span class="token constant">HASH_MAX_LEN</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;set&quot;</span><span class="token operator">:</span>
                        len <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">scard</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        maxLen <span class="token operator">=</span> <span class="token constant">HASH_MAX_LEN</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;zset&quot;</span><span class="token operator">:</span>
                        len <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">zcard</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        maxLen <span class="token operator">=</span> <span class="token constant">HASH_MAX_LEN</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">default</span><span class="token operator">:</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;=</span> maxLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Found big key : %s, type: %s, length or size: %d %n&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> type<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>cursor<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">void</span> <span class="token function">tearDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jedis <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h5 id="_3第三方工具"><a href="#_3第三方工具" class="header-anchor">#</a> ③第三方工具</h5> <ul><li>利用第三方工具，如 Redis-Rdb-Tools 分析RDB快照文件，全面分析内存使用情况</li> <li>https://github.com/sripathikrishnan/redis-rdb-tools</li></ul> <h5 id="_4网络监控"><a href="#_4网络监控" class="header-anchor">#</a> ④网络监控</h5> <ul><li>自定义工具，监控进出Redis的网络数据，超出预警值时主动告警</li> <li>一般阿里云搭建的云服务器就有相关监控页面</li></ul> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20220521140415785.png" alt="image-20220521140415785"></p> <h4 id="_1-2-3、如何删除bigkey"><a href="#_1-2-3、如何删除bigkey" class="header-anchor">#</a> 1.2.3、如何删除BigKey</h4> <p>BigKey内存占用较多，即便时删除这样的key也需要耗费很长时间，导致Redis主线程阻塞，引发一系列问题。</p> <ul><li>redis 3.0 及以下版本
<ul><li>如果是集合类型，则遍历BigKey的元素，先逐个删除子元素，最后删除BigKey</li></ul></li></ul> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20220521140621204.png" alt="image-20220521140621204"></p> <ul><li>Redis 4.0以后
<ul><li>Redis在4.0后提供了异步删除的命令：unlink</li></ul></li></ul> <h3 id="恰当的数据类型"><a href="#恰当的数据类型" class="header-anchor">#</a> 恰当的数据类型</h3> <h4 id="例1-比如存储一个user对象-我们有三种存储方式"><a href="#例1-比如存储一个user对象-我们有三种存储方式" class="header-anchor">#</a> 例1：比如存储一个User对象，我们有三种存储方式：</h4> <h5 id="_1方式一-json字符串"><a href="#_1方式一-json字符串" class="header-anchor">#</a> ①方式一：json字符串</h5> <table><thead><tr><th style="text-align:center;">user:1</th> <th style="text-align:center;">{&quot;name&quot;: &quot;Jack&quot;, &quot;age&quot;: 21}</th></tr></thead> <tbody></tbody></table> <p>优点：实现简单粗暴</p> <p>缺点：数据耦合，不够灵活</p> <h5 id="_2方式二-字段打散"><a href="#_2方式二-字段打散" class="header-anchor">#</a> ②方式二：字段打散</h5> <table><thead><tr><th style="text-align:center;">user:1:name</th> <th style="text-align:center;">Jack</th></tr></thead> <tbody><tr><td style="text-align:center;">user:1:age</td> <td style="text-align:center;">21</td></tr></tbody></table> <p>优点：可以灵活访问对象任意字段</p> <p>缺点：占用空间大、没办法做统一控制</p> <h5 id="_3方式三-hash-推荐"><a href="#_3方式三-hash-推荐" class="header-anchor">#</a> ③方式三：hash（推荐）</h5> <table><tr><td rowspan="2">user:1</td> <td>name</td> <td>jack</td></tr> <tr><td>age</td> <td>21</td></tr></table> <p>优点：底层使用ziplist，空间占用小，可以灵活访问对象的任意字段</p> <p>缺点：代码相对复杂</p> <h4 id="例2-假如有hash类型的key-其中有100万对field和value-field是自增id-这个key存在什么问题-如何优化"><a href="#例2-假如有hash类型的key-其中有100万对field和value-field是自增id-这个key存在什么问题-如何优化" class="header-anchor">#</a> 例2：假如有hash类型的key，其中有100万对field和value，field是自增id，这个key存在什么问题？如何优化？</h4> <table><tr style="color:red;"><td>key</td> <td>field</td> <td>value</td></tr> <tr><td rowspan="3">someKey</td> <td>id:0</td> <td>value0</td></tr> <tr><td>.....</td> <td>.....</td></tr> <tr><td>id:999999</td> <td>value999999</td></tr></table> <p>存在的问题：</p> <ul><li>hash的entry数量超过500时，会使用哈希表而不是ZipList，内存占用较多
<ul><li><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20220521142943350.png" alt="image-20220521142943350"></li></ul></li> <li>可以通过hash-max-ziplist-entries配置entry上限。但是如果entry过多就会导致BigKey问题</li></ul> <h5 id="方案一"><a href="#方案一" class="header-anchor">#</a> 方案一</h5> <p>拆分为string类型</p> <table><tr style="color:red;"><td>key</td> <td>value</td></tr> <tr><td>id:0</td> <td>value0</td></tr> <tr><td>.....</td> <td>.....</td></tr> <tr><td>id:999999</td> <td>value999999</td></tr></table> <p>存在的问题：</p> <ul><li>string结构底层没有太多内存优化，内存占用较多</li></ul> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20220521143458010.png" alt="image-20220521143458010"></p> <ul><li>想要批量获取这些数据比较麻烦</li></ul> <h5 id="方案二"><a href="#方案二" class="header-anchor">#</a> 方案二</h5> <p>拆分为小的hash，将 id / 100 作为key， 将id % 100 作为field，这样每100个元素为一个Hash</p> <table><tr style="color:red;"><td>key</td> <td>field</td> <td>value</td></tr> <tr><td rowspan="3">key:0</td> <td>id:00</td> <td>value0</td></tr> <tr><td>.....</td> <td>.....</td></tr> <tr><td>id:99</td> <td>value99</td></tr> <tr><td rowspan="3">key:1</td> <td>id:00</td> <td>value100</td></tr> <tr><td>.....</td> <td>.....</td></tr> <tr><td>id:99</td> <td>value199</td></tr> <tr><td colspan="3">....</td></tr> <tr><td rowspan="3">key:9999</td> <td>id:00</td> <td>value999900</td></tr> <tr><td>.....</td> <td>.....</td></tr> <tr><td>id:99</td> <td>value999999</td></tr></table> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20220521144339377.png" alt="image-20220521144339377"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>test</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">JedisConnectionFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">AfterEach</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">BeforeEach</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span><span class="token class-name">Jedis</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span><span class="token class-name">Pipeline</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span><span class="token class-name">ScanResult</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Jedis</span> jedis<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.建立连接</span>
        <span class="token comment">// jedis = new Jedis(&quot;192.168.150.101&quot;, 6379);</span>
        jedis <span class="token operator">=</span> <span class="token class-name">JedisConnectionFactory</span><span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.设置密码</span>
        jedis<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">&quot;123321&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.选择库</span>
        jedis<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testSetBigKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">650</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;hello_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">&quot;world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        jedis<span class="token punctuation">.</span><span class="token function">hmset</span><span class="token punctuation">(</span><span class="token string">&quot;m2&quot;</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testBigHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;key_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">&quot;value_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        jedis<span class="token punctuation">.</span><span class="token function">hmset</span><span class="token punctuation">(</span><span class="token string">&quot;test:big:hash&quot;</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testBigString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;test:str:key_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">&quot;value_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testSmallHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> hashSize <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>hashSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> hashSize<span class="token punctuation">;</span>
            <span class="token keyword">int</span> v <span class="token operator">=</span> i <span class="token operator">%</span> hashSize<span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;key_&quot;</span> <span class="token operator">+</span> v<span class="token punctuation">,</span> <span class="token string">&quot;value_&quot;</span> <span class="token operator">+</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                jedis<span class="token punctuation">.</span><span class="token function">hmset</span><span class="token punctuation">(</span><span class="token string">&quot;test:small:hash_&quot;</span> <span class="token operator">+</span> k<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">void</span> <span class="token function">tearDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jedis <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <ul><li>Key的最佳实践
<ul><li>固定格式：[业务名]:[数据名]:[id]</li> <li>足够简短：不超过44字节</li> <li>不包含特殊字符</li></ul></li> <li>Value的最佳实践：
<ul><li>合理的拆分数据，拒绝BigKey</li> <li>选择合适数据结构</li> <li>Hash结构的entry数量不要超过1000</li> <li>设置合理的超时时间</li></ul></li></ul> <h2 id="批处理优化"><a href="#批处理优化" class="header-anchor">#</a> 批处理优化</h2> <h3 id="pipeline"><a href="#pipeline" class="header-anchor">#</a> Pipeline</h3> <h4 id="我们的客户端与redis服务器是这样交互的"><a href="#我们的客户端与redis服务器是这样交互的" class="header-anchor">#</a> 我们的客户端与redis服务器是这样交互的</h4> <p>单个命令的执行流程</p> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20220521151459880.png" alt="image-20220521151459880"></p> <p>N条命令的执行流程</p> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20220521151524621.png" alt="image-20220521151524621"></p> <p>redis处理指令是很快的，主要花费的时候在于网络传输。于是乎很容易想到将多条指令批量的传输给redis</p> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20220521151902080.png" alt="image-20220521151902080"></p> <h4 id="mset"><a href="#mset" class="header-anchor">#</a> MSet</h4> <p>Redis提供了很多Mxxx这样的命令，可以实现批量插入数据，例如：</p> <ul><li>mset</li> <li>hmset</li></ul> <p>利用mset批量插入10万条数据</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testMxx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">2000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> j<span class="token punctuation">;</span>
    <span class="token keyword">long</span> b <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        j <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
        arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;test:key_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
        arr<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;value_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jedis<span class="token punctuation">.</span><span class="token function">mset</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">long</span> e <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;time: &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>e <span class="token operator">-</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="pipeline-2"><a href="#pipeline-2" class="header-anchor">#</a> Pipeline</h4> <p>MSET虽然可以批处理，但是却只能操作部分数据类型，因此如果有对复杂数据类型的批处理需要，建议使用Pipeline</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testPipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建管道</span>
    <span class="token class-name">Pipeline</span> pipeline <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">pipelined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> b <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 放入命令到管道</span>
        pipeline<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;test:key_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">&quot;value_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">1000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 每放入1000条命令，批量执行</span>
            pipeline<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">long</span> e <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;time: &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>e <span class="token operator">-</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="集群下的批处理"><a href="#集群下的批处理" class="header-anchor">#</a> 集群下的批处理</h3> <p>如MSET或Pipeline这样的批处理需要在一次请求中携带多条命令，而此时如果Redis是一个集群，那批处理命令的多个key必须落在一个插槽中，否则就会导致执行失败。大家可以想一想这样的要求其实很难实现，因为我们在批处理时，可能一次要插入很多条数据，这些数据很有可能不会都落在相同的节点上，这就会导致报错了</p> <p>这个时候，我们可以找到4种解决方案</p> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/1653126446641.png" alt="1653126446641"></p> <p>第一种方案：串行执行，所以这种方式没有什么意义，当然，执行起来就很简单了，缺点就是耗时过久。</p> <p>第二种方案：串行slot，简单来说，就是执行前，客户端先计算一下对应的key的slot，一样slot的key就放到一个组里边，不同的，就放到不同的组里边，然后对每个组执行pipeline的批处理，他就能串行执行各个组的命令，这种做法比第一种方法耗时要少，但是缺点呢，相对来说复杂一点，所以这种方案还需要优化一下</p> <p>第三种方案：并行slot，相较于第二种方案，在分组完成后串行执行，第三种方案，就变成了并行执行各个命令，所以他的耗时就非常短，但是实现呢，也更加复杂。</p> <p>第四种：hash_tag，redis计算key的slot的时候，其实是根据key的有效部分来计算的，通过这种方式就能一次处理所有的key，这种方式耗时最短，实现也简单，但是如果通过操作key的有效部分，那么就会导致所有的key都落在一个节点上，产生数据倾斜的问题，所以我们推荐使用第三种方式。</p> <h4 id="串行化执行代码实践"><a href="#串行化执行代码实践" class="header-anchor">#</a> 串行化执行代码实践</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisClusterTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">JedisCluster</span> jedisCluster<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 配置连接池</span>
        <span class="token class-name">JedisPoolConfig</span> poolConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        poolConfig<span class="token punctuation">.</span><span class="token function">setMaxTotal</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        poolConfig<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        poolConfig<span class="token punctuation">.</span><span class="token function">setMinIdle</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        poolConfig<span class="token punctuation">.</span><span class="token function">setMaxWaitMillis</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HostAndPort</span><span class="token punctuation">&gt;</span></span> nodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.150.101&quot;</span><span class="token punctuation">,</span> <span class="token number">7001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.150.101&quot;</span><span class="token punctuation">,</span> <span class="token number">7002</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.150.101&quot;</span><span class="token punctuation">,</span> <span class="token number">7003</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.150.101&quot;</span><span class="token punctuation">,</span> <span class="token number">8001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.150.101&quot;</span><span class="token punctuation">,</span> <span class="token number">8002</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.150.101&quot;</span><span class="token punctuation">,</span> <span class="token number">8003</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedisCluster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisCluster</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span> poolConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testMSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        jedisCluster<span class="token punctuation">.</span><span class="token function">mset</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Jack&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;21&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sex&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;male&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testMSet2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Jack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;21&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;sex&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Male&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//对Map数据进行分组。根据相同的slot放在一个分组</span>
        <span class="token comment">//key就是slot，value就是一个组</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>
                        entry <span class="token operator">-&gt;</span> <span class="token class-name">ClusterSlotHashUtil</span><span class="token punctuation">.</span><span class="token function">calculateSlot</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//串行的去执行mset的逻辑</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">:</span> result<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                j <span class="token operator">=</span> i<span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                arr<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            jedisCluster<span class="token punctuation">.</span><span class="token function">mset</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">void</span> <span class="token function">tearDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jedisCluster <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jedisCluster<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="spring集群环境下批处理代码"><a href="#spring集群环境下批处理代码" class="header-anchor">#</a> Spring集群环境下批处理代码</h4> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testMSetInCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Rose&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;21&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;sex&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Female&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiSet</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> strings <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sex&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        strings<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre></div><p><strong>原理分析</strong></p> <p>在RedisAdvancedClusterAsyncCommandsImpl 类中</p> <p>首先根据slotHash算出来一个partitioned的map，map中的key就是slot，而他的value就是对应的对应相同slot的key对应的数据</p> <p>通过 RedisFuture&lt;String&gt; mset = super.mset(op);进行异步的消息发送</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RedisFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">mset</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> partitioned <span class="token operator">=</span> <span class="token class-name">SlotHash</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span>codec<span class="token punctuation">,</span> map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>partitioned<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">mset</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">RedisFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> executions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> partitioned<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> op <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> op<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">RedisFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mset <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">mset</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
        executions<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token class-name">MultiNodeExecution</span><span class="token punctuation">.</span><span class="token function">firstOfAsync</span><span class="token punctuation">(</span>executions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="服务器端优化-持久化配置"><a href="#服务器端优化-持久化配置" class="header-anchor">#</a> 服务器端优化-持久化配置</h2> <p>Redis的持久化虽然可以保证数据安全，但也会带来很多额外的开销，因此持久化请遵循下列建议：</p> <ul><li>用来做缓存的Redis实例尽量不要开启持久化功能</li> <li>建议关闭RDB持久化功能，使用AOF持久化</li> <li>利用脚本定期在slave节点做RDB，实现数据备份</li> <li>设置合理的rewrite阈值，避免频繁的bgrewrite</li> <li>配置no-appendfsync-on-rewrite = yes，禁止在rewrite期间做aof，避免因AOF引起的阻塞</li> <li>部署有关建议：
<ul><li>Redis实例的物理机要预留足够内存，应对fork和rewrite</li> <li>单个Redis实例内存上限不要太大，例如4G或8G。可以加快fork的速度、减少主从同步、数据迁移压力</li> <li>不要与CPU密集型应用部署在一起</li> <li>不要与高硬盘负载应用一起部署。例如：数据库、消息队列</li></ul></li></ul> <h2 id="服务器端优化-慢查询优化"><a href="#服务器端优化-慢查询优化" class="header-anchor">#</a> 服务器端优化-慢查询优化</h2> <h3 id="什么是慢查询"><a href="#什么是慢查询" class="header-anchor">#</a> 什么是慢查询</h3> <p>并不是很慢的查询才是慢查询，而是：在Redis执行时耗时超过某个阈值的命令，称为慢查询。</p> <p>慢查询的危害：由于Redis是单线程的，所以当客户端发出指令后，他们都会进入到redis底层的queue来执行，如果此时有一些慢查询的数据，就会导致大量请求阻塞，从而引起报错，所以我们需要解决慢查询问题。</p> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/1653129590210.png" alt="1653129590210"></p> <p>慢查询的阈值可以通过配置指定：</p> <p>slowlog-log-slower-than：慢查询阈值，单位是微秒。默认是10000，建议1000</p> <p>慢查询会被放入慢查询日志中，日志的长度有上限，可以通过配置指定：</p> <p>slowlog-max-len：慢查询日志（本质是一个队列）的长度。默认是128，建议1000</p> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/1653130457771.png" alt="1653130457771"></p> <p>修改这两个配置可以使用：config set命令：</p> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/1653130475979.png" alt="1653130475979"></p> <h3 id="如何查看慢查询"><a href="#如何查看慢查询" class="header-anchor">#</a> 如何查看慢查询</h3> <p>知道了以上内容之后，那么咱们如何去查看慢查询日志列表呢：</p> <ul><li>slowlog len：查询慢查询日志长度</li> <li>slowlog get [n]：读取n条慢查询日志</li> <li>slowlog reset：清空慢查询列表</li></ul> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/1653130858066.png" alt="1653130858066"></p> <h2 id="服务器端优化-命令及安全配置"><a href="#服务器端优化-命令及安全配置" class="header-anchor">#</a> 服务器端优化-命令及安全配置</h2> <p>安全可以说是服务器端一个非常重要的话题，如果安全出现了问题，那么一旦这个漏洞被一些坏人知道了之后，并且进行攻击，那么这就会给咱们的系统带来很多的损失，所以我们这节课就来解决这个问题。</p> <p>Redis会绑定在0.0.0.0:6379，这样将会将Redis服务暴露到公网上，而Redis如果没有做身份认证，会出现严重的安全漏洞.
漏洞重现方式：https://cloud.tencent.com/developer/article/1039000</p> <p>为什么会出现不需要密码也能够登录呢，主要是Redis考虑到每次登录都比较麻烦，所以Redis就有一种ssh免秘钥登录的方式，生成一对公钥和私钥，私钥放在本地，公钥放在redis端，当我们登录时服务器，再登录时候，他会去解析公钥和私钥，如果没有问题，则不需要利用redis的登录也能访问，这种做法本身也很常见，但是这里有一个前提，前提就是公钥必须保存在服务器上，才行，但是Redis的漏洞在于在不登录的情况下，也能把秘钥送到Linux服务器，从而产生漏洞</p> <p>漏洞出现的核心的原因有以下几点：</p> <ul><li>Redis未设置密码</li> <li>利用了Redis的config set命令动态修改Redis配置</li> <li>使用了Root账号权限启动Redis</li></ul> <p>所以：如何解决呢？我们可以采用如下几种方案</p> <p>为了避免这样的漏洞，这里给出一些建议：</p> <ul><li>Redis一定要设置密码</li> <li>禁止线上使用下面命令：keys、flushall、flushdb、config set等命令。可以利用rename-command禁用。</li> <li>bind：限制网卡，禁止外网网卡访问</li> <li>开启防火墙</li> <li>不要使用Root账户启动Redis</li> <li>尽量不是有默认的端口</li></ul> <h2 id="服务器端优化-redis内存划分和内存配置"><a href="#服务器端优化-redis内存划分和内存配置" class="header-anchor">#</a> 服务器端优化-Redis内存划分和内存配置</h2> <p>当Redis内存不足时，可能导致Key频繁被删除、响应时间变长、QPS不稳定等问题。当内存使用率达到90%以上时就需要我们警惕，并快速定位到内存占用的原因。</p> <p><strong>有关碎片问题分析</strong></p> <p>Redis底层分配并不是这个key有多大，他就会分配多大，而是有他自己的分配策略，比如8,16,20等等，假定当前key只需要10个字节，此时分配8肯定不够，那么他就会分配16个字节，多出来的6个字节就不能被使用，这就是我们常说的 碎片问题</p> <p><strong>进程内存问题分析：</strong></p> <p>这片内存，通常我们都可以忽略不计</p> <p><strong>缓冲区内存问题分析：</strong></p> <p>一般包括客户端缓冲区、AOF缓冲区、复制缓冲区等。客户端缓冲区又包括输入缓冲区和输出缓冲区两种。这部分内存占用波动较大，所以这片内存也是我们需要重点分析的内存问题。</p> <table><thead><tr><th><strong>内存占用</strong></th> <th><strong>说明</strong></th></tr></thead> <tbody><tr><td>数据内存</td> <td>是Redis最主要的部分，存储Redis的键值信息。主要问题是BigKey问题、内存碎片问题</td></tr> <tr><td>进程内存</td> <td>Redis主进程本身运⾏肯定需要占⽤内存，如代码、常量池等等；这部分内存⼤约⼏兆，在⼤多数⽣产环境中与Redis数据占⽤的内存相⽐可以忽略。</td></tr> <tr><td>缓冲区内存</td> <td>一般包括客户端缓冲区、AOF缓冲区、复制缓冲区等。客户端缓冲区又包括输入缓冲区和输出缓冲区两种。这部分内存占用波动较大，不当使用BigKey，可能导致内存溢出。</td></tr></tbody></table> <p>于是我们就需要通过一些命令，可以查看到Redis目前的内存分配状态：</p> <ul><li>info memory：查看内存分配的情况</li></ul> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/1653132073570.png" alt="1653132073570"></p> <ul><li>memory xxx：查看key的主要占用情况</li></ul> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/1653132098823.png" alt="1653132098823"></p> <p>接下来我们看到了这些配置，最关键的缓存区内存如何定位和解决呢？</p> <p>内存缓冲区常见的有三种：</p> <ul><li>复制缓冲区：主从复制的repl_backlog_buf，如果太小可能导致频繁的全量复制，影响性能。通过replbacklog-size来设置，默认1mb</li> <li>AOF缓冲区：AOF刷盘之前的缓存区域，AOF执行rewrite的缓冲区。无法设置容量上限</li> <li>客户端缓冲区：分为输入缓冲区和输出缓冲区，输入缓冲区最大1G且不能设置。输出缓冲区可以设置</li></ul> <p>以上复制缓冲区和AOF缓冲区 不会有问题，最关键就是客户端缓冲区的问题</p> <p>客户端缓冲区：指的就是我们发送命令时，客户端用来缓存命令的一个缓冲区，也就是我们向redis输入数据的输入端缓冲区和redis向客户端返回数据的响应缓存区，输入缓冲区最大1G且不能设置，所以这一块我们根本不用担心，如果超过了这个空间，redis会直接断开，因为本来此时此刻就代表着redis处理不过来了，我们需要担心的就是输出端缓冲区</p> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/1653132410073.png" alt="1653132410073"></p> <p>我们在使用redis过程中，处理大量的big value，那么会导致我们的输出结果过多，如果输出缓存区过大，会导致redis直接断开，而默认配置的情况下， 其实他是没有大小的，这就比较坑了，内存可能一下子被占满，会直接导致咱们的redis断开，所以解决方案有两个</p> <p>1、设置一个大小</p> <p>2、增加我们带宽的大小，避免我们出现大量数据从而直接超过了redis的承受能力</p> <h2 id="服务器端集群优化-集群还是主从"><a href="#服务器端集群优化-集群还是主从" class="header-anchor">#</a> 服务器端集群优化-集群还是主从</h2> <p>集群虽然具备高可用特性，能实现自动故障恢复，但是如果使用不当，也会存在一些问题：</p> <ul><li>集群完整性问题</li> <li>集群带宽问题</li> <li>数据倾斜问题</li> <li>客户端性能问题</li> <li>命令的集群兼容性问题</li> <li>lua和事务问题</li></ul> <p><strong>问题1、在Redis的默认配置中，如果发现任意一个插槽不可用，则整个集群都会停止对外服务：</strong></p> <p>大家可以设想一下，如果有几个slot不能使用，那么此时整个集群都不能用了，我们在开发中，其实最重要的是可用性，所以需要把如下配置修改成no，即有slot不能使用时，我们的redis集群还是可以对外提供服务</p> <p><img src="/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/1653132740637.png" alt="1653132740637"></p> <p><strong>问题2、集群带宽问题</strong></p> <p>集群节点之间会不断的互相Ping来确定集群中其它节点的状态。每次Ping携带的信息至少包括：</p> <ul><li>插槽信息</li> <li>集群状态信息</li></ul> <p>集群中节点越多，集群状态信息数据量也越大，10个节点的相关信息可能达到1kb，此时每次集群互通需要的带宽会非常高，这样会导致集群中大量的带宽都会被ping信息所占用，这是一个非常可怕的问题，所以我们需要去解决这样的问题</p> <p><strong>解决途径：</strong></p> <ul><li>避免大集群，集群节点数不要太多，最好少于1000，如果业务庞大，则建立多个集群。</li> <li>避免在单个物理机中运行太多Redis实例</li> <li>配置合适的cluster-node-timeout值</li></ul> <p><strong>问题3、命令的集群兼容性问题</strong></p> <p>有关这个问题咱们已经探讨过了，当我们使用批处理的命令时，redis要求我们的key必须落在相同的slot上，然后大量的key同时操作时，是无法完成的，所以客户端必须要对这样的数据进行处理，这些方案我们之前已经探讨过了，所以不再这个地方赘述了。</p> <p><strong>问题4、lua和事务的问题</strong></p> <p>lua和事务都是要保证原子性问题，如果你的key不在一个节点，那么是无法保证lua的执行和事务的特性的，所以在集群模式是没有办法执行lua和事务的</p> <p><strong>那我们到底是集群还是主从</strong></p> <p>单体Redis（主从Redis）已经能达到万级别的QPS，并且也具备很强的高可用特性。如果主从能满足业务需求的情况下，所以如果不是在万不得已的情况下，尽量不搭建Redis集群</p></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=%E7%9F%A5%E8%AF%86" title="标签">#知识</a><a href="/tags/?tag=%E6%95%B0%E6%8D%AE%E5%BA%93" title="标签">#数据库</a><a href="/tags/?tag=Redis" title="标签">#Redis</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023 07 3</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/94a219/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">RedisAPI</div></a> <a href="/pages/7c7a2d/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Redis持久化</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/94a219/" class="prev">RedisAPI</a></span> <span class="next"><a href="/pages/7c7a2d/">Redis持久化</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/0446de/"><div>
            数据层解决方案
            <!----></div></a> <span class="date">07-03</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/e76fff/"><div>
            第三方技术整合
            <!----></div></a> <span class="date">07-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/cd183e/"><div>
            原理篇
            <!----></div></a> <span class="date">07-03</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:1693849288@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/diana-devil" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://y.qq.com/n/ryqq/playlist/3202075040" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2023
    <span>by 凉冰 </span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----><!----><canvas id="vuepress-canvas-cursor"></canvas><div class="reco-bgm-panel" data-v-b1d3339e><audio id="bgm" src="/bgm/G_E_M_ 邓紫棋 - FIND YOU.ogg" data-v-b1d3339e></audio> <div class="reco-float-box" style="bottom:200px;z-index:999999;display:none;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><img src="/bgm/GEM.jpg" data-v-b1d3339e></div> <div class="reco-bgm-box" style="left:10px;bottom:10px;z-index:999999;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="reco-bgm-cover" style="background-image:url(/bgm/GEM.jpg);" data-v-b1d3339e><div class="mini-operation" style="display:none;" data-v-b1d3339e><i class="reco-bgm reco-bgm-pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play" style="display:none;" data-v-b1d3339e></i></div> <div class="falut-message" style="display:none;" data-v-b1d3339e>
          播放失败
        </div></div> <div class="reco-bgm-info" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-music music" data-v-b1d3339e></i>FIND YOU</div> <div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-artist" data-v-b1d3339e></i>G_E_M_ 邓紫棋</div> <div class="reco-bgm-progress" data-v-b1d3339e><div class="progress-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div> <div class="reco-bgm-operation" data-v-b1d3339e><i class="reco-bgm reco-bgm-last last" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-pause pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play play" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-next next" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-volume1 volume" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-mute mute" style="display:none;" data-v-b1d3339e></i> <div class="volume-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div></div> <div class="reco-bgm-left-box" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><i class="reco-bgm reco-bgm-left" data-v-b1d3339e></i></div></div></div></div></div>
    <script src="/assets/js/app.3ee2b30c.js" defer></script><script src="/assets/js/2.fc657b59.js" defer></script><script src="/assets/js/53.8347b740.js" defer></script><script src="/assets/js/3.e0ec9727.js" defer></script>
  </body>
</html>
