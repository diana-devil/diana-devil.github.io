(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{388:function(a,s,e){"use strict";e.r(s);var t=e(2),v=Object(t.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("p",[a._v("Redis有两种持久化方案：")]),a._v(" "),s("ul",[s("li",[a._v("RDB持久化")]),a._v(" "),s("li",[a._v("AOF持久化")])]),a._v(" "),s("h2",{attrs:{id:"rdb持久化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#rdb持久化"}},[a._v("#")]),a._v(" RDB持久化")]),a._v(" "),s("p",[a._v("RDB全称Redis Database Backup file（Redis数据备份文件），也被叫做Redis数据快照。简单来说就是把内存中的所有数据都记录到磁盘中。当Redis实例故障重启后，从磁盘读取快照文件，恢复数据。快照文件称为RDB文件，默认是保存在当前运行目录。")]),a._v(" "),s("h3",{attrs:{id:"执行时机"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#执行时机"}},[a._v("#")]),a._v(" 执行时机")]),a._v(" "),s("p",[a._v("RDB持久化在四种情况下会执行：")]),a._v(" "),s("ul",[s("li",[a._v("执行save命令")]),a._v(" "),s("li",[a._v("执行bgsave命令")]),a._v(" "),s("li",[a._v("Redis停机时")]),a._v(" "),s("li",[a._v("触发RDB条件时")])]),a._v(" "),s("p",[s("code",[a._v("默认存储")]),a._v("地方就是当前执行命令的地方"),s("code",[a._v("./")]),a._v("，名称为"),s("code",[a._v("dump.rdb")])]),a._v(" "),s("p",[s("strong",[a._v("1）save命令")])]),a._v(" "),s("p",[a._v("执行下面的命令，可以立即执行一次RDB：")]),a._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20210725144536958.png",alt:"image-20210725144536958"}})]),a._v(" "),s("p",[a._v("save命令会导致主进程执行RDB，这个过程中其它所有命令都会被阻塞。只有在数据迁移时可能用到。")]),a._v(" "),s("p",[s("strong",[a._v("2）bgsave命令")])]),a._v(" "),s("p",[a._v("下面的命令可以异步执行RDB：")]),a._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20210725144725943.png",alt:"image-20210725144725943"}})]),a._v(" "),s("p",[a._v("这个命令执行后会开启独立进程完成RDB，主进程可以持续处理用户请求，不受影响。")]),a._v(" "),s("p",[s("strong",[a._v("3）停机时")])]),a._v(" "),s("p",[a._v("Redis停机时会执行一次save命令，实现RDB持久化。")]),a._v(" "),s("p",[s("strong",[a._v("4）触发RDB条件")])]),a._v(" "),s("p",[a._v("Redis内部有触发RDB的机制，可以在redis.conf文件中找到，格式如下：")]),a._v(" "),s("div",{staticClass:"language-properties extra-class"},[s("pre",{pre:!0,attrs:{class:"language-properties"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v('# 900秒内，如果至少有1个key被修改，则执行bgsave ， 如果是save "" 则表示禁用RDB')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("save")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("900 1  ")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("save")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("300 10  ")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("save")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("60 10000 ")]),a._v("\n")])])]),s("p",[a._v("RDB的其它配置也可以在redis.conf文件中设置：")]),a._v(" "),s("div",{staticClass:"language-properties extra-class"},[s("pre",{pre:!0,attrs:{class:"language-properties"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 是否压缩 ,建议不开启，压缩也会消耗cpu，磁盘的话不值钱")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("rdbcompression")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("yes")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# RDB文件名称")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("dbfilename")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("dump.rdb  ")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 文件保存的路径目录")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("dir")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("./ ")]),a._v("\n")])])]),s("h3",{attrs:{id:"rdb原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#rdb原理"}},[a._v("#")]),a._v(" RDB原理")]),a._v(" "),s("p",[a._v("bgsave开始时会fork主进程得到子进程，子进程共享主进程的内存数据。完成fork后读取内存数据并写入 RDB 文件。")]),a._v(" "),s("p",[a._v("fork采用的是copy-on-write技术：")]),a._v(" "),s("ul",[s("li",[a._v("当主进程执行读操作时，访问共享内存；")]),a._v(" "),s("li",[a._v("当主进程执行写操作时，则会拷贝一份数据，执行写操作。")])]),a._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20210725151319695.png",alt:"image-20210725151319695"}})]),a._v(" "),s("h3",{attrs:{id:"小结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[a._v("#")]),a._v(" 小结")]),a._v(" "),s("p",[a._v("RDB方式bgsave的基本流程？")]),a._v(" "),s("ul",[s("li",[a._v("fork主进程得到一个子进程，共享内存空间")]),a._v(" "),s("li",[a._v("子进程读取内存数据并写入新的RDB文件")]),a._v(" "),s("li",[a._v("用新RDB文件替换旧的RDB文件")])]),a._v(" "),s("p",[a._v("RDB会在什么时候执行？save 60 1000代表什么含义？")]),a._v(" "),s("ul",[s("li",[a._v("默认是服务停止时**(save)**")]),a._v(" "),s("li",[a._v("代表60秒内至少执行1000次修改则触发RDB**(bgsave)**")])]),a._v(" "),s("p",[s("strong",[a._v("RDB的缺点？")])]),a._v(" "),s("ul",[s("li",[a._v("RDB执行间隔时间长，两次RDB之间写入数据有丢失的风险")]),a._v(" "),s("li",[a._v("fork子进程、压缩、写出RDB文件都比较耗时")])]),a._v(" "),s("h2",{attrs:{id:"aof持久化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aof持久化"}},[a._v("#")]),a._v(" AOF持久化")]),a._v(" "),s("h3",{attrs:{id:"aof原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aof原理"}},[a._v("#")]),a._v(" AOF原理")]),a._v(" "),s("p",[a._v("AOF全称为Append Only File（追加文件）。Redis处理的每一个写命令都会记录在AOF文件，可以看做是命令日志文件。")]),a._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20210725151543640.png",alt:"image-20210725151543640"}})]),a._v(" "),s("h3",{attrs:{id:"aof配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aof配置"}},[a._v("#")]),a._v(" AOF配置")]),a._v(" "),s("p",[a._v("AOF默认是关闭的，需要修改redis.conf配置文件来开启AOF：")]),a._v(" "),s("div",{staticClass:"language-properties extra-class"},[s("pre",{pre:!0,attrs:{class:"language-properties"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 是否开启AOF功能，默认是no")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("appendonly")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("yes")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# AOF文件的名称")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("appendfilename")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v('"appendonly.aof"')]),a._v("\n")])])]),s("p",[a._v("AOF的命令记录的频率也可以通过redis.conf文件来配：")]),a._v(" "),s("div",{staticClass:"language-properties extra-class"},[s("pre",{pre:!0,attrs:{class:"language-properties"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 表示每执行一次写命令，立即记录到AOF文件")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("appendfsync")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("always ")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 写命令执行完先放入AOF缓冲区，然后表示每隔1秒将缓冲区数据写到AOF文件，是默认方案")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("appendfsync")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("everysec ")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 写命令执行完先放入AOF缓冲区，由操作系统决定何时将缓冲区内容写回磁盘")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("appendfsync")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("no")]),a._v("\n")])])]),s("p",[a._v("三种策略对比：")]),a._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20210725151654046.png",alt:"image-20210725151654046"}})]),a._v(" "),s("h3",{attrs:{id:"aof文件重写"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aof文件重写"}},[a._v("#")]),a._v(" AOF文件重写")]),a._v(" "),s("p",[a._v("因为是记录命令，AOF文件会比RDB文件大的多。而且AOF会记录对同一个key的多次写操作，但只有最后一次写操作才有意义。通过执行bgrewriteaof命令，可以让AOF文件执行重写功能，用最少的命令达到相同效果。")]),a._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20210725151729118.png",alt:"image-20210725151729118"}})]),a._v(" "),s("p",[a._v("如图，AOF原本有三个命令，但是"),s("code",[a._v("set num 123 和 set num 666")]),a._v("都是对num的操作，第二次会覆盖第一次的值，因此第一个命令记录下来没有意义。")]),a._v(" "),s("p",[a._v("所以重写命令后，AOF文件内容就是："),s("code",[a._v("mset name jack num 666")])]),a._v(" "),s("p",[a._v("Redis也会在触发阈值时自动去重写AOF文件。阈值也可以在redis.conf中配置：")]),a._v(" "),s("div",{staticClass:"language-properties extra-class"},[s("pre",{pre:!0,attrs:{class:"language-properties"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# AOF文件比上次文件 增长超过多少百分比则触发重写")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("auto-aof-rewrite-percentage")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("100")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# AOF文件体积最小多大以上才触发重写 ")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("auto-aof-rewrite-min-size")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("64mb ")]),a._v("\n")])])]),s("h2",{attrs:{id:"rdb与aof对比"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#rdb与aof对比"}},[a._v("#")]),a._v(" RDB与AOF对比")]),a._v(" "),s("p",[a._v("RDB和AOF各有自己的优缺点，如果对数据安全性要求较高，在实际开发中往往会"),s("strong",[a._v("结合")]),a._v("两者来使用。")]),a._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20210725151940515.png",alt:"image-20210725151940515"}})])])}),[],!1,null,null,null);s.default=v.exports}}]);