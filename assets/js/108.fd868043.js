(window.webpackJsonp=window.webpackJsonp||[]).push([[108],{446:function(t,a,s){"use strict";s.r(a);var n=s(2),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("下面我们就一起学习下Seata中的四种不同的事务模式。")]),t._v(" "),a("h2",{attrs:{id:"xa模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#xa模式"}},[t._v("#")]),t._v(" XA模式")]),t._v(" "),a("p",[t._v("XA 规范 是 X/Open 组织定义的分布式事务处理（DTP，Distributed Transaction Processing）标准，XA 规范 描述了全局的TM与局部的RM之间的接口，几乎所有主流的数据库都对 XA 规范 提供了支持。")]),t._v(" "),a("h3",{attrs:{id:"两阶段提交"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#两阶段提交"}},[t._v("#")]),t._v(" 两阶段提交")]),t._v(" "),a("p",[t._v("XA是规范，目前主流数据库都实现了这种规范，实现的原理都是基于两阶段提交。")]),t._v(" "),a("p",[t._v("正常情况：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724174102768.png",alt:"image-20210724174102768"}})]),t._v(" "),a("p",[t._v("异常情况：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724174234987.png",alt:"image-20210724174234987"}})]),t._v(" "),a("p",[t._v("一阶段：")]),t._v(" "),a("ul",[a("li",[t._v("事务协调者通知每个事物参与者执行本地事务")]),t._v(" "),a("li",[t._v("本地事务执行完成后报告事务执行状态给事务协调者，此时事务不提交，继续持有数据库锁")])]),t._v(" "),a("p",[t._v("二阶段：")]),t._v(" "),a("ul",[a("li",[t._v("事务协调者基于一阶段的报告来判断下一步操作\n"),a("ul",[a("li",[t._v("如果一阶段都成功，则通知所有事务参与者，提交事务")]),t._v(" "),a("li",[t._v("如果一阶段任意一个参与者失败，则通知所有事务参与者回滚事务")])])])]),t._v(" "),a("h3",{attrs:{id:"seata的xa模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#seata的xa模型"}},[t._v("#")]),t._v(" Seata的XA模型")]),t._v(" "),a("p",[t._v("Seata对原始的XA模式做了简单的封装和改造，以适应自己的事务模型，基本架构如图：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724174424070.png",alt:"image-20210724174424070"}})]),t._v(" "),a("p",[t._v("RM一阶段的工作：")]),t._v(" "),a("p",[t._v("​\t① 注册分支事务到TC")]),t._v(" "),a("p",[t._v("​\t② 执行分支业务sql但不提交")]),t._v(" "),a("p",[t._v("​\t③ 报告执行状态到TC")]),t._v(" "),a("p",[t._v("TC二阶段的工作：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("TC检测各分支事务执行状态")]),t._v(" "),a("p",[t._v("a.如果都成功，通知所有RM提交事务")]),t._v(" "),a("p",[t._v("b.如果有失败，通知所有RM回滚事务")])])]),t._v(" "),a("p",[t._v("RM二阶段的工作：")]),t._v(" "),a("ul",[a("li",[t._v("接收TC指令，提交或回滚事务")])]),t._v(" "),a("h3",{attrs:{id:"优缺点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优缺点"}},[t._v("#")]),t._v(" 优缺点")]),t._v(" "),a("p",[t._v("XA模式的优点是什么？")]),t._v(" "),a("ul",[a("li",[t._v("事务的强一致性，满足ACID原则。")]),t._v(" "),a("li",[t._v("常用数据库都支持，实现简单，并且没有代码侵入")])]),t._v(" "),a("p",[t._v("XA模式的缺点是什么？")]),t._v(" "),a("ul",[a("li",[t._v("因为一阶段需要锁定数据库资源，等待二阶段结束才释放，性能较差")]),t._v(" "),a("li",[t._v("依赖关系型数据库实现事务，如果数据库不支持，则不会成功")])]),t._v(" "),a("h3",{attrs:{id:"实现xa模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现xa模式"}},[t._v("#")]),t._v(" 实现XA模式")]),t._v(" "),a("p",[t._v("Seata的starter已经完成了XA模式的自动装配，实现非常简单，步骤如下：")]),t._v(" "),a("p",[t._v("1）修改application.yml文件（每个参与事务的微服务），开启XA模式：")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("seata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data-source-proxy-mode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" XA\n")])])]),a("p",[t._v("2）给发起全局事务的入口方法添加@GlobalTransactional注解:")]),t._v(" "),a("p",[t._v("本例中是OrderServiceImpl中的create方法.")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724174859556.png",alt:"image-20210724174859556"}})]),t._v(" "),a("p",[t._v("3）重启服务并测试")]),t._v(" "),a("p",[t._v("重启order-service，再次测试，发现无论怎样，三个微服务都能成功回滚。")]),t._v(" "),a("h2",{attrs:{id:"at模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#at模式"}},[t._v("#")]),t._v(" AT模式")]),t._v(" "),a("p",[a("strong",[t._v("Seata默认是AT模式")])]),t._v(" "),a("p",[t._v("AT模式同样是分阶段提交的事务模型，不过缺弥补了XA模型中资源锁定周期过长的缺陷。")]),t._v(" "),a("h3",{attrs:{id:"seata的at模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#seata的at模型"}},[t._v("#")]),t._v(" Seata的AT模型")]),t._v(" "),a("p",[t._v("基本流程图：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724175327511.png",alt:"image-20210724175327511"}})]),t._v(" "),a("p",[t._v("阶段一RM的工作：")]),t._v(" "),a("ul",[a("li",[t._v("注册分支事务")]),t._v(" "),a("li",[a("strong",[t._v("记录undo-log（数据快照）")])]),t._v(" "),a("li",[a("strong",[t._v("执行业务sql并提交")])]),t._v(" "),a("li",[t._v("报告事务状态")])]),t._v(" "),a("p",[t._v("阶段二提交时RM的工作：")]),t._v(" "),a("ul",[a("li",[t._v("删除undo-log即可")])]),t._v(" "),a("p",[t._v("阶段二回滚时RM的工作：")]),t._v(" "),a("ul",[a("li",[t._v("根据undo-log恢复数据到更新前")]),t._v(" "),a("li",[t._v("删除undo-log")])]),t._v(" "),a("h3",{attrs:{id:"流程梳理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#流程梳理"}},[t._v("#")]),t._v(" 流程梳理")]),t._v(" "),a("p",[t._v("我们用一个真实的业务来梳理下AT模式的原理。")]),t._v(" "),a("p",[t._v("比如，现在又一个数据库表，记录用户余额：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[a("strong",[t._v("id")])]),t._v(" "),a("th",[a("strong",[t._v("money")])])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("1")]),t._v(" "),a("td",[t._v("100")])])])]),t._v(" "),a("p",[t._v("其中一个分支业务要执行的SQL为：")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("update")]),t._v(" tb_account "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v(" money "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" money "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("where")]),t._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n")])])]),a("p",[t._v("AT模式下，当前分支事务执行流程如下：")]),t._v(" "),a("p",[t._v("一阶段：")]),t._v(" "),a("p",[t._v("1）TM发起并注册全局事务到TC")]),t._v(" "),a("p",[t._v("2）TM调用分支事务")]),t._v(" "),a("p",[t._v("3）分支事务准备执行业务SQL")]),t._v(" "),a("p",[t._v("4）RM拦截业务SQL，根据where条件查询原始数据，形成快照。")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"money"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("5）RM执行业务SQL，提交本地事务，释放数据库锁。此时 "),a("code",[t._v("money = 90")])]),t._v(" "),a("p",[t._v("6）RM报告本地事务状态给TC")]),t._v(" "),a("p",[t._v("二阶段：")]),t._v(" "),a("p",[t._v("1）TM通知TC事务结束")]),t._v(" "),a("p",[t._v("2）TC检查分支事务状态")]),t._v(" "),a("p",[t._v("​\t a）如果都成功，则立即删除快照")]),t._v(" "),a("p",[t._v("​\t b）如果有分支事务失败，需要回滚。读取快照数据（"),a("code",[t._v('{"id": 1, "money": 100}')]),t._v("），将快照恢复到数据库。此时数据库再次恢复为100")]),t._v(" "),a("p",[t._v("流程图：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724180722921.png",alt:"image-20210724180722921"}})]),t._v(" "),a("h3",{attrs:{id:"at与xa的区别"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#at与xa的区别"}},[t._v("#")]),t._v(" AT与XA的区别")]),t._v(" "),a("p",[t._v("简述AT模式与XA模式最大的区别是什么？")]),t._v(" "),a("ul",[a("li",[t._v("XA模式一阶段不提交事务，锁定资源；AT模式一阶段直接提交，不锁定资源。")]),t._v(" "),a("li",[t._v("XA模式依赖数据库机制实现回滚；AT模式利用数据快照实现数据回滚。")]),t._v(" "),a("li",[t._v("XA模式强一致；AT模式最终一致")])]),t._v(" "),a("h3",{attrs:{id:"脏写问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#脏写问题"}},[t._v("#")]),t._v(" 脏写问题")]),t._v(" "),a("p",[t._v("在多线程并发访问AT模式的分布式事务时，有可能出现脏写问题，如图：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724181541234.png",alt:"image-20210724181541234"}})]),t._v(" "),a("p",[t._v("解决思路就是引入了全局锁的概念。在释放DB锁之前，先拿到全局锁。避免同一时刻有另外一个事务来操作当前数据。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724181843029.png",alt:"image-20210724181843029"}})]),t._v(" "),a("p",[a("strong",[t._v("全局锁与DB锁")])]),t._v(" "),a("ul",[a("li",[t._v("DB锁不释放，其他事务无法对数据库进行任何操作。——XA\n"),a("ul",[a("li",[t._v("DB锁是数据库的")])])]),t._v(" "),a("li",[t._v("全局锁只锁定该事务正在修改的某个表的某行数据的某列，其他事务可以对数据库中的其他数据进行操作。——AT\n"),a("ul",[a("li",[t._v("全局锁是 Seata的")])])])]),t._v(" "),a("p",[t._v("极端情况处理")]),t._v(" "),a("ul",[a("li",[t._v("非Seata管理全局事务介入同一事物。")])]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/%E9%9D%9Eseata%E7%AE%A1%E7%90%86%E5%85%A8%E5%B1%80%E4%BA%8B%E5%8A%A1.png",alt:""}})]),t._v(" "),a("h3",{attrs:{id:"优缺点-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优缺点-2"}},[t._v("#")]),t._v(" 优缺点")]),t._v(" "),a("p",[t._v("AT模式的优点：")]),t._v(" "),a("ul",[a("li",[t._v("一阶段完成直接提交事务，释放数据库资源，性能比较好")]),t._v(" "),a("li",[t._v("利用全局锁实现读写隔离")]),t._v(" "),a("li",[t._v("没有代码侵入，框架自动完成回滚和提交")])]),t._v(" "),a("p",[t._v("AT模式的缺点：")]),t._v(" "),a("ul",[a("li",[t._v("两阶段之间属于软状态，属于最终一致")]),t._v(" "),a("li",[t._v("框架的快照功能会影响性能，但比XA模式要好很多")])]),t._v(" "),a("h3",{attrs:{id:"实现at模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现at模式"}},[t._v("#")]),t._v(" 实现AT模式")]),t._v(" "),a("p",[t._v("AT模式中的快照生成、回滚等动作都是由框架自动完成，没有任何代码侵入，因此实现非常简单。")]),t._v(" "),a("p",[t._v("只不过，AT模式需要一个表来记录全局锁、另一张表来记录数据快照undo_log。")]),t._v(" "),a("p",[t._v("1）导入数据库表，记录全局锁")]),t._v(" "),a("p",[t._v("导入课前资料提供的Sql文件：seata-at.sql，其中lock_table导入到TC服务关联的数据库，undo_log表导入到微服务关联的数据库：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724182217272.png",alt:"image-20210724182217272"}})]),t._v(" "),a("p",[t._v("2）修改application.yml文件，将事务模式修改为AT模式即可：")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("seata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data-source-proxy-mode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" AT "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 默认就是AT")]),t._v("\n")])])]),a("p",[t._v("3）重启服务并测试")]),t._v(" "),a("p",[a("strong",[t._v("两个表中的数据用了就删了")])]),t._v(" "),a("h2",{attrs:{id:"tcc模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tcc模式"}},[t._v("#")]),t._v(" TCC模式")]),t._v(" "),a("p",[t._v("TCC模式与AT模式非常相似，每阶段都是独立事务，不同的是TCC通过人工编码来实现数据恢复。需要实现三个方法：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("Try：资源的检测和预留；")])]),t._v(" "),a("li",[a("p",[t._v("Confirm：完成资源操作业务；要求 Try 成功 Confirm 一定要能成功。")])]),t._v(" "),a("li",[a("p",[t._v("Cancel：预留资源释放，可以理解为try的反向操作。")])])]),t._v(" "),a("h3",{attrs:{id:"流程分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#流程分析"}},[t._v("#")]),t._v(" 流程分析")]),t._v(" "),a("p",[t._v("举例，一个扣减用户余额的业务。假设账户A原来余额是100，需要余额扣减30元。")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("阶段一（ Try ）")]),t._v("：检查余额是否充足，如果充足则冻结金额增加30元，可用余额扣除30")])]),t._v(" "),a("p",[t._v("初识余额：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724182424907.png",alt:"image-20210724182424907"}})]),t._v(" "),a("p",[t._v("余额充足，可以冻结：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724182457951.png",alt:"image-20210724182457951"}})]),t._v(" "),a("p",[t._v("此时，总金额 = 冻结金额 + 可用金额，数量依然是100不变。事务直接提交无需等待其它事务。")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("阶段二（Confirm)")]),t._v("：假如要提交（Confirm），则冻结金额扣减30")])]),t._v(" "),a("p",[t._v("确认可以提交，不过之前可用金额已经扣减过了，这里只要清除冻结金额就好了：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724182706011.png",alt:"image-20210724182706011"}})]),t._v(" "),a("p",[t._v("此时，总金额 = 冻结金额 + 可用金额 = 0 + 70  = 70元")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("阶段二(Canncel)")]),t._v("：如果要回滚（Cancel），则冻结金额扣减30，可用余额增加30")])]),t._v(" "),a("p",[t._v("需要回滚，那么就要释放冻结金额，恢复可用金额：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724182810734.png",alt:"image-20210724182810734"}})]),t._v(" "),a("h3",{attrs:{id:"seata的tcc模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#seata的tcc模型"}},[t._v("#")]),t._v(" Seata的TCC模型")]),t._v(" "),a("p",[t._v("Seata中的TCC模型依然延续之前的事务架构，如图：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724182937713.png",alt:"image-20210724182937713"}})]),t._v(" "),a("h3",{attrs:{id:"优缺点-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优缺点-3"}},[t._v("#")]),t._v(" 优缺点")]),t._v(" "),a("p",[t._v("TCC模式的每个阶段是做什么的？")]),t._v(" "),a("ul",[a("li",[t._v("Try：资源检查和预留")]),t._v(" "),a("li",[t._v("Confirm：业务执行和提交")]),t._v(" "),a("li",[t._v("Cancel：预留资源的释放")])]),t._v(" "),a("p",[t._v("TCC的优点是什么？")]),t._v(" "),a("ul",[a("li",[t._v("一阶段完成直接提交事务，释放数据库资源，性能好")]),t._v(" "),a("li",[t._v("相比AT模型，无需生成快照，无需使用全局锁，性能最强")]),t._v(" "),a("li",[t._v("不依赖数据库事务，而是依赖补偿操作，可以用于非事务型数据库")])]),t._v(" "),a("p",[t._v("TCC的缺点是什么？")]),t._v(" "),a("ul",[a("li",[t._v("有代码侵入，需要人为编写try、Confirm和Cancel接口，太麻烦")]),t._v(" "),a("li",[t._v("软状态，事务是最终一致")]),t._v(" "),a("li",[t._v("需要考虑Confirm和Cancel的失败情况，做好"),a("strong",[t._v("幂等处理")]),t._v(" "),a("ul",[a("li",[t._v("幂等 就是   执行几次结果都是一样的。")]),t._v(" "),a("li",[t._v("因为任务执行失败后，seata会重新尝试执行，有可能造成多次提交事务")])])])]),t._v(" "),a("h3",{attrs:{id:"事务悬挂和空回滚"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务悬挂和空回滚"}},[t._v("#")]),t._v(" 事务悬挂和空回滚")]),t._v(" "),a("h4",{attrs:{id:"_1-空回滚"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-空回滚"}},[t._v("#")]),t._v(" 1）空回滚")]),t._v(" "),a("p",[t._v("当某分支事务的try阶段"),a("strong",[t._v("阻塞")]),t._v("时，可能导致全局事务超时而触发二阶段的cancel操作。在未执行try操作时先执行了cancel操作，这时cancel不能做回滚，就是"),a("strong",[t._v("空回滚")]),t._v("。")]),t._v(" "),a("p",[t._v("如图：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724183426891.png",alt:"image-20210724183426891"}})]),t._v(" "),a("p",[t._v("执行cancel操作时，应当判断try是否已经执行，如果尚未执行，则应该空回滚。")]),t._v(" "),a("h4",{attrs:{id:"_2-业务悬挂"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-业务悬挂"}},[t._v("#")]),t._v(" 2）业务悬挂")]),t._v(" "),a("p",[t._v("对于已经空回滚的业务，之前被阻塞的try操作恢复，继续执行try，就永远不可能confirm或cancel ，事务一直处于中间状态，这就是"),a("strong",[t._v("业务悬挂")]),t._v("。")]),t._v(" "),a("p",[t._v("执行try操作时，应当判断cancel是否已经执行过了，如果已经执行，应当阻止空回滚后的try操作，避免悬挂")]),t._v(" "),a("h3",{attrs:{id:"实现tcc模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现tcc模式"}},[t._v("#")]),t._v(" 实现TCC模式")]),t._v(" "),a("p",[t._v("解决空回滚和业务悬挂问题，必须要记录当前事务状态，是在try、还是cancel？")]),t._v(" "),a("h4",{attrs:{id:"_1-思路分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-思路分析"}},[t._v("#")]),t._v(" 1）思路分析")]),t._v(" "),a("p",[t._v("这里我们定义一张表：")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("account_freeze_tbl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("xid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("varchar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("128")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("user_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("varchar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("255")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DEFAULT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COMMENT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'用户id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("freeze_money"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DEFAULT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'0'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COMMENT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'冻结金额'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DEFAULT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COMMENT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'事务状态，0:try，1:confirm，2:cancel'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("xid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("USING")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BTREE")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENGINE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("InnoDB")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DEFAULT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CHARSET")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("utf8 ROW_FORMAT"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("COMPACT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),a("p",[t._v("其中：")]),t._v(" "),a("ul",[a("li",[t._v("xid：是全局事务id")]),t._v(" "),a("li",[t._v("freeze_money：用来记录用户冻结金额")]),t._v(" "),a("li",[t._v("state：用来记录事务状态")])]),t._v(" "),a("p",[t._v("那此时，我们的业务开怎么做呢？")]),t._v(" "),a("ul",[a("li",[t._v("Try业务：\n"),a("ul",[a("li",[t._v("记录冻结金额和事务状态到account_freeze表")]),t._v(" "),a("li",[t._v("扣减account表可用金额")])])]),t._v(" "),a("li",[t._v("Confirm业务\n"),a("ul",[a("li",[t._v("根据xid删除account_freeze表的冻结记录")])])]),t._v(" "),a("li",[t._v("Cancel业务\n"),a("ul",[a("li",[t._v("修改account_freeze表，冻结金额为0，state为2")]),t._v(" "),a("li",[t._v("修改account表，恢复可用金额")])])]),t._v(" "),a("li",[t._v("如何判断是否空回滚？\n"),a("ul",[a("li",[t._v("cancel业务中，根据xid查询account_freeze，如果为null则说明try还没做，需要空回滚")])])]),t._v(" "),a("li",[t._v("如何避免业务悬挂？\n"),a("ul",[a("li",[t._v("try业务中，根据xid查询account_freeze ，如果已经存在则证明Cancel已经执行，拒绝执行try业务")])])])]),t._v(" "),a("p",[t._v("接下来，我们改造account-service，利用TCC实现余额扣减功能。")]),t._v(" "),a("h4",{attrs:{id:"_2-声明tcc接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-声明tcc接口"}},[t._v("#")]),t._v(" 2）声明TCC接口")]),t._v(" "),a("p",[t._v("TCC的Try、Confirm、Cancel方法都需要在接口中基于注解来声明，")]),t._v(" "),a("p",[t._v("我们在account-service项目中的"),a("code",[t._v("cn.itcast.account.service")]),t._v("包中新建一个接口，声明TCC三个接口：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("cn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("itcast"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("account"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("service")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token import"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("seata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tcc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("api"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BusinessActionContext")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token import"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("seata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tcc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("api"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BusinessActionContextParameter")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token import"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("seata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tcc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("api"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LocalTCC")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token import"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("seata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tcc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("api"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TwoPhaseBusinessAction")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@LocalTCC")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AccountTCCService")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@TwoPhaseBusinessAction")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deduct"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" commitMethod "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"confirm"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rollbackMethod "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cancel"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("deduct")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@BusinessActionContextParameter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("paramName "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"userId"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" userId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@BusinessActionContextParameter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("paramName "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"money"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" money"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("confirm")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BusinessActionContext")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cancel")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BusinessActionContext")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h4",{attrs:{id:"_3-编写实现类"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-编写实现类"}},[t._v("#")]),t._v(" 3）编写实现类")]),t._v(" "),a("p",[t._v("在account-service服务中的"),a("code",[t._v("cn.itcast.account.service.impl")]),t._v("包下新建一个类，实现TCC业务：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("cn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("itcast"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("account"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("impl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token import"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("cn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("itcast"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("account"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("entity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AccountFreeze")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token import"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("cn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("itcast"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("account"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AccountFreezeMapper")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token import"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("cn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("itcast"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("account"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AccountMapper")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token import"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("cn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("itcast"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("account"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AccountTCCService")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token import"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("seata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("core"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RootContext")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token import"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("seata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tcc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("api"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BusinessActionContext")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token import"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("lombok"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("extern"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("slf4j"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Slf4j")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token import"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("beans"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("factory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Autowired")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token import"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stereotype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Service")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token import"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("transaction"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Transactional")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Service")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Slf4j")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AccountTCCServiceImpl")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AccountTCCService")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AccountMapper")]),t._v(" accountMapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AccountFreezeMapper")]),t._v(" freezeMapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Transactional")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("deduct")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" userId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" money"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 0.获取事务id")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" xid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RootContext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getXID")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1.扣减可用余额")]),t._v("\n        accountMapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("deduct")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("userId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" money"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2.记录冻结金额，事务状态")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AccountFreeze")]),t._v(" freeze "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AccountFreeze")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        freeze"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setUserId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("userId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        freeze"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setFreezeMoney")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("money"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        freeze"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AccountFreeze"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("State")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TRY")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        freeze"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setXid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("xid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        freezeMapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("insert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("freeze"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("confirm")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BusinessActionContext")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1.获取事务id")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" xid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getXid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2.根据id删除冻结记录")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" count "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" freezeMapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("deleteById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("xid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" count "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cancel")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BusinessActionContext")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 0.查询冻结记录")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" xid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getXid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AccountFreeze")]),t._v(" freeze "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" freezeMapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("selectById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("xid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1.恢复可用余额")]),t._v("\n        accountMapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("refund")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("freeze"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUserId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" freeze"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getFreezeMoney")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2.将冻结金额清零，状态改为CANCEL")]),t._v("\n        freeze"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setFreezeMoney")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        freeze"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AccountFreeze"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("State")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CANCEL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" count "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" freezeMapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("freeze"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" count "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"saga模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#saga模式"}},[t._v("#")]),t._v(" SAGA模式")]),t._v(" "),a("p",[t._v("Saga 模式是 Seata 即将开源的长事务解决方案，将由蚂蚁金服主要贡献。")]),t._v(" "),a("p",[t._v("其理论基础是Hector & Kenneth  在1987年发表的论文"),a("a",{attrs:{href:"https://microservices.io/patterns/data/saga.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Sagas"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("p",[t._v("Seata官网对于Saga的指南：https://seata.io/zh-cn/docs/user/saga.html")]),t._v(" "),a("h3",{attrs:{id:"原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[t._v("#")]),t._v(" 原理")]),t._v(" "),a("p",[t._v("在 Saga 模式下，分布式事务内有多个参与者，每一个参与者都是一个冲正补偿服务，需要用户根据业务场景实现其正向操作和逆向回滚操作。")]),t._v(" "),a("p",[t._v("分布式事务执行过程中，依次执行各参与者的正向操作，如果所有正向操作均执行成功，那么分布式事务提交。如果任何一个正向操作执行失败，那么分布式事务会去退回去执行前面各参与者的逆向回滚操作，回滚已提交的参与者，使分布式事务回到初始状态。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724184846396.png",alt:"image-20210724184846396"}})]),t._v(" "),a("p",[t._v("Saga也分为两个阶段：")]),t._v(" "),a("ul",[a("li",[t._v("一阶段：直接提交本地事务")]),t._v(" "),a("li",[t._v("二阶段：成功则什么都不做；失败则通过编写补偿业务来回滚")])]),t._v(" "),a("h3",{attrs:{id:"优缺点-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优缺点-4"}},[t._v("#")]),t._v(" 优缺点")]),t._v(" "),a("p",[t._v("优点：")]),t._v(" "),a("ul",[a("li",[t._v("事务参与者可以基于事件驱动实现异步调用，吞吐高")]),t._v(" "),a("li",[t._v("一阶段直接提交事务，无锁，性能好")]),t._v(" "),a("li",[t._v("不用编写TCC中的三个阶段，实现简单")])]),t._v(" "),a("p",[t._v("缺点：")]),t._v(" "),a("ul",[a("li",[t._v("软状态持续时间不确定，时效性差")]),t._v(" "),a("li",[t._v("没有锁，没有事务隔离，会有脏写")])]),t._v(" "),a("h2",{attrs:{id:"四种模式对比"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四种模式对比"}},[t._v("#")]),t._v(" 四种模式对比")]),t._v(" "),a("p",[a("strong",[t._v("AT最多")])]),t._v(" "),a("p",[a("strong",[t._v("追求极致性能，或者设计到非关系型数据库时 使用 TCC")])]),t._v(" "),a("p",[t._v("我们从以下几个方面来对比四种实现：")]),t._v(" "),a("ul",[a("li",[t._v("一致性：能否保证事务的一致性？强一致还是最终一致？")]),t._v(" "),a("li",[t._v("隔离性：事务之间的隔离性如何？")]),t._v(" "),a("li",[t._v("代码侵入：是否需要对业务代码改造？")]),t._v(" "),a("li",[t._v("性能：有无性能损耗？")]),t._v(" "),a("li",[t._v("场景：常见的业务场景")])]),t._v(" "),a("p",[t._v("如图：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210724185021819.png",alt:"image-20210724185021819"}})])])}),[],!1,null,null,null);a.default=e.exports}}]);