(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{386:function(s,a,t){"use strict";t.r(a);var e=t(2),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"集群结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#集群结构"}},[s._v("#")]),s._v(" 集群结构")]),s._v(" "),a("p",[s._v("我们搭建的主从集群结构如图：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20210630111505799.png",alt:"image-20210630111505799"}})]),s._v(" "),a("p",[s._v("共包含三个节点，一个主节点，两个从节点。")]),s._v(" "),a("p",[s._v("这里我们会在同一台虚拟机中开启3个redis实例，模拟主从集群，信息如下：")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[s._v("IP")]),s._v(" "),a("th",{staticStyle:{"text-align":"center"}},[s._v("PORT")]),s._v(" "),a("th",{staticStyle:{"text-align":"center"}},[s._v("角色")])])]),s._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.150.101")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("7001")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("master")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.150.101")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("7002")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("slave")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.150.101")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("7003")]),s._v(" "),a("td",{staticStyle:{"text-align":"center"}},[s._v("slave")])])])]),s._v(" "),a("h2",{attrs:{id:"准备实例和配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备实例和配置"}},[s._v("#")]),s._v(" 准备实例和配置")]),s._v(" "),a("p",[s._v("要在同一台虚拟机开启3个实例，必须准备三份不同的配置文件和目录，配置文件所在目录也就是工作目录。")]),s._v(" "),a("p",[s._v("1）创建目录")]),s._v(" "),a("p",[s._v("我们创建三个文件夹，名字分别叫7001、7002、7003：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入/tmp目录")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /tmp\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建目录")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v("\n")])])]),a("p",[s._v("如图：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20210630113929868.png",alt:"image-20210630113929868"}})]),s._v(" "),a("p",[s._v("2）恢复原始配置")]),s._v(" "),a("p",[s._v("修改redis-6.2.4/redis.conf文件，将其中的持久化模式改为默认的RDB模式，AOF保持关闭状态。")]),s._v(" "),a("div",{staticClass:"language-properties extra-class"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启RDB")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# save ""')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("save")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("3600 1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("save")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("300 100")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("save")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("60 10000")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭AOF")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("appendonly")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("no")]),s._v("\n")])])]),a("p",[s._v("3）拷贝配置文件到每个实例目录")]),s._v(" "),a("p",[s._v("然后将redis-6.2.4/redis.conf文件拷贝到三个目录中（在/tmp目录执行下列命令）：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方式一：逐个拷贝")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" redis-6.2.4/redis.conf "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" redis-6.2.4/redis.conf "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" redis-6.2.4/redis.conf "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方式二：管道组合命令，一键拷贝")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("xargs")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" redis-6.2.4/redis.conf\n")])])]),a("p",[s._v("4）修改每个实例的端口、工作目录")]),s._v(" "),a("p",[s._v("修改每个文件夹内的配置文件，将端口分别修改为7001、7002、7003，将rdb文件保存位置都修改为自己所在目录（在/tmp目录执行下列命令）：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/6379/7001/g'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/dir .\\//dir \\/tmp\\/7001\\//g'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("/redis.conf\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/6379/7002/g'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/dir .\\//dir \\/tmp\\/7002\\//g'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v("/redis.conf\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/6379/7003/g'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/dir .\\//dir \\/tmp\\/7003\\//g'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v("/redis.conf\n")])])]),a("p",[s._v("5）修改每个实例的声明IP")]),s._v(" "),a("p",[s._v("虚拟机本身有多个IP，为了避免将来混乱，我们需要在redis.conf文件中指定每一个实例的绑定ip信息，格式如下：")]),s._v(" "),a("div",{staticClass:"language-properties extra-class"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis实例的声明 IP")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("replica-announce-ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("192.168.150.101")]),s._v("\n")])])]),a("p",[s._v("每个目录都要改，我们一键完成修改（在/tmp目录执行下列命令）：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 逐一执行")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1a replica-announce-ip 192.168.150.101'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("/redis.conf\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1a replica-announce-ip 192.168.150.101'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v("/redis.conf\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1a replica-announce-ip 192.168.150.101'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v("/redis.conf\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或者一键修改")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("printf")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%s\\n'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("xargs")]),s._v(" -I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1a replica-announce-ip 192.168.150.101'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("/redis.conf\n")])])]),a("h2",{attrs:{id:"启动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动"}},[s._v("#")]),s._v(" 启动")]),s._v(" "),a("p",[s._v("为了方便查看日志，我们打开3个ssh窗口，分别启动3个redis实例，启动命令：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第1个")]),s._v("\nredis-server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("/redis.conf\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第2个")]),s._v("\nredis-server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v("/redis.conf\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第3个")]),s._v("\nredis-server "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v("/redis.conf\n")])])]),a("p",[s._v("启动后：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20210630183914491.png",alt:"image-20210630183914491"}})]),s._v(" "),a("p",[s._v("如果要一键停止，可以运行下面命令：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("printf")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%s\\n'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("xargs")]),s._v(" -I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" redis-cli "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("shutdown")]),s._v("\n")])])]),a("h2",{attrs:{id:"开启主从关系"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#开启主从关系"}},[s._v("#")]),s._v(" 开启主从关系")]),s._v(" "),a("p",[s._v("现在三个实例还没有任何关系，要配置主从可以使用replicaof 或者slaveof（5.0以前）命令。")]),s._v(" "),a("p",[s._v("有临时和永久两种模式：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("修改配置文件（永久生效）")]),s._v(" "),a("ul",[a("li",[s._v("在redis.conf中添加一行配置："),a("code",[s._v("slaveof <masterip> <masterport>")])])])]),s._v(" "),a("li",[a("p",[s._v("使用redis-cli客户端连接到redis服务，执行slaveof命令（重启后失效）：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("slaveof "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("masterip"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("masterport"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])])])])]),s._v(" "),a("p",[a("strong",[a("font",{attrs:{color:"red"}},[s._v("注意")])],1),s._v("：在5.0以后新增命令replicaof，与salveof效果一致。")]),s._v(" "),a("p",[s._v("这里我们为了演示方便，使用方式二。")]),s._v(" "),a("p",[s._v("通过redis-cli命令连接7002，执行下面命令：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接 7002")]),s._v("\nredis-cli "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行slaveof")]),s._v("\nslaveof "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.101 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("\n")])])]),a("p",[s._v("通过redis-cli命令连接7003，执行下面命令：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接 7003")]),s._v("\nredis-cli "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行slaveof")]),s._v("\nslaveof "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.101 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("\n")])])]),a("p",[s._v("然后连接 7001节点，查看集群状态：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接 7001")]),s._v("\nredis-cli "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看状态")]),s._v("\ninfo replication\n")])])]),a("p",[s._v("结果：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/image-20210630201258802.png",alt:"image-20210630201258802"}})]),s._v(" "),a("h2",{attrs:{id:"测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[s._v("#")]),s._v(" 测试")]),s._v(" "),a("p",[s._v("执行下列操作以测试：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("利用redis-cli连接7001，执行"),a("code",[s._v("set num 123")])])]),s._v(" "),a("li",[a("p",[s._v("利用redis-cli连接7002，执行"),a("code",[s._v("get num")]),s._v("，再执行"),a("code",[s._v("set num 666")])])]),s._v(" "),a("li",[a("p",[s._v("利用redis-cli连接7003，执行"),a("code",[s._v("get num")]),s._v("，再执行"),a("code",[s._v("set num 888")])])])]),s._v(" "),a("p",[s._v("可以发现，只有在7001这个master节点上可以执行写操作，7002和7003这两个slave节点只能执行读操作。")])])}),[],!1,null,null,null);a.default=r.exports}}]);