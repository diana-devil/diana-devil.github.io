(window.webpackJsonp=window.webpackJsonp||[]).push([[110],{447:function(t,s,a){"use strict";a.r(s);var r=a(2),e=Object(r.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("雪崩问题虽然有四种方案，但是限流是避免服务因突发的流量而发生故障，是对微服务雪崩问题的预防。我们先学习这种模式。")]),t._v(" "),s("h2",{attrs:{id:"簇点链路"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#簇点链路"}},[t._v("#")]),t._v(" 簇点链路")]),t._v(" "),s("p",[t._v("当请求进入微服务时，首先会访问DispatcherServlet，然后进入Controller、Service、Mapper，这样的一个调用链就叫做"),s("strong",[t._v("簇点链路")]),t._v("。簇点链路中被监控的每一个接口就是一个"),s("strong",[t._v("资源")]),t._v("。")]),t._v(" "),s("p",[t._v("默认情况下sentinel会监控SpringMVC的每一个端点（Endpoint，也就是controller中的方法），因此SpringMVC的每一个端点（Endpoint）就是调用链路中的一个资源。")]),t._v(" "),s("p",[t._v("例如，我们刚才访问的order-service中的OrderController中的端点：/order/{orderId}")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210715191757319.png",alt:"image-20210715191757319"}})]),t._v(" "),s("p",[t._v("流控、熔断等都是针对簇点链路中的资源来设置的，因此我们可以点击对应资源后面的按钮来设置规则：")]),t._v(" "),s("ul",[s("li",[t._v("流控：流量控制")]),t._v(" "),s("li",[t._v("降级：降级熔断")]),t._v(" "),s("li",[t._v("热点：热点参数限流，是限流的一种")]),t._v(" "),s("li",[t._v("授权：请求的权限控制")])]),t._v(" "),s("h2",{attrs:{id:"快速入门"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#快速入门"}},[t._v("#")]),t._v(" 快速入门")]),t._v(" "),s("h3",{attrs:{id:"示例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#示例"}},[t._v("#")]),t._v(" 示例")]),t._v(" "),s("p",[t._v("点击资源/order/{orderId}后面的流控按钮，就可以弹出表单。")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210715191757319.png",alt:"image-20210715191757319"}})]),t._v(" "),s("p",[t._v("表单中可以填写限流规则，如下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210715192010657.png",alt:"image-20210715192010657"}})]),t._v(" "),s("p",[s("strong",[t._v("其含义是限制 /order/{orderId}这个资源的单机QPS为1，即每秒只允许1次请求，超出的请求会被拦截并报错。")])]),t._v(" "),s("h3",{attrs:{id:"练习"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#练习"}},[t._v("#")]),t._v(" 练习：")]),t._v(" "),s("p",[t._v("需求：给 /order/{orderId}这个资源设置流控规则，QPS不能超过 5，然后测试。")]),t._v(" "),s("p",[t._v("1）首先在sentinel控制台添加限流规则")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210715192455429.png",alt:"image-20210715192455429"}})]),t._v(" "),s("p",[t._v("2）利用jmeter测试")]),t._v(" "),s("p",[t._v("如果没有用过jmeter，可以参考课前资料提供的文档《Jmeter快速入门.md》")]),t._v(" "),s("p",[t._v("课前资料提供了编写好的Jmeter测试样例：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210715200431615.png",alt:"image-20210715200431615"}})]),t._v(" "),s("p",[t._v("打开jmeter，导入课前资料提供的测试样例：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210715200537171.png",alt:"image-20210715200537171"}})]),t._v(" "),s("p",[t._v("选择：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210715200635414.png",alt:"image-20210715200635414"}})]),t._v(" "),s("p",[t._v("20个用户，2秒内运行完，QPS是10，超过了5.")]),t._v(" "),s("p",[t._v("选中"),s("code",[t._v("流控入门，QPS<5")]),t._v("右键运行：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210715200804594.png",alt:"image-20210715200804594"}})]),t._v(" "),s("blockquote",[s("p",[t._v("注意，不要点击菜单中的执行按钮来运行。")])]),t._v(" "),s("p",[t._v("结果：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210715200853671.png",alt:"image-20210715200853671"}})]),t._v(" "),s("p",[t._v("可以看到，成功的请求每次只有5个")]),t._v(" "),s("h2",{attrs:{id:"流控模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#流控模式"}},[t._v("#")]),t._v(" 流控模式")]),t._v(" "),s("p",[t._v("在添加限流规则时，点击高级选项，可以选择三种"),s("strong",[t._v("流控模式")]),t._v("：")]),t._v(" "),s("ul",[s("li",[t._v("直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是"),s("strong",[t._v("默认的模式")])]),t._v(" "),s("li",[t._v("关联：统计与"),s("strong",[t._v("当前资源相关的另一个资源")]),t._v("，触发阈值时，对当前资源限流")]),t._v(" "),s("li",[t._v("链路：统计从"),s("strong",[t._v("指定链路")]),t._v("访问到本资源的请求，触发阈值时，对指定链路限流")])]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210715201827886.png",alt:"image-20210715201827886"}})]),t._v(" "),s("p",[t._v("快速入门测试的就是直接模式。")]),t._v(" "),s("h3",{attrs:{id:"关联模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#关联模式"}},[t._v("#")]),t._v(" 关联模式")]),t._v(" "),s("p",[s("strong",[t._v("关联模式")]),t._v("：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流")]),t._v(" "),s("p",[s("strong",[t._v("配置规则")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210715202540786.png",alt:"image-20210715202540786"}})]),t._v(" "),s("p",[s("strong",[t._v("语法说明")]),t._v("：当/write资源访问量触发阈值时，就会对/read资源限流，避免影响/write资源。")]),t._v(" "),s("p",[s("strong",[t._v("使用场景")]),t._v("：比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。业务需求是优先支付和更新订单的业务，因此当修改订单业务触发阈值时，需要对查询订单业务限流。")]),t._v(" "),s("p",[s("strong",[t._v("需求说明")]),t._v("：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("在OrderController新建两个端点：/order/query和/order/update，无需实现业务")])]),t._v(" "),s("li",[s("p",[t._v("配置流控规则，当/order/ update资源被访问的QPS超过5时，对/order/query请求限流")])])]),t._v(" "),s("p",[t._v("1）定义/order/query端点，模拟订单查询")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@GetMapping")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/query"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("queryOrder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"查询订单成功"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("2）定义/order/update端点，模拟订单更新")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@GetMapping")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/update"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateOrder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"更新订单成功"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("重启服务，查看sentinel控制台的簇点链路：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716101805951.png",alt:"image-20210716101805951"}})]),t._v(" "),s("p",[t._v("3）配置流控规则")]),t._v(" "),s("p",[t._v("对哪个端点限流，就点击哪个端点后面的按钮。我们是对订单查询/order/query限流，因此点击它后面的按钮：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716101934499.png",alt:"image-20210716101934499"}})]),t._v(" "),s("p",[t._v("在表单中填写流控规则：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716102103814.png",alt:"image-20210716102103814"}})]),t._v(" "),s("p",[t._v("4）在Jmeter测试")]),t._v(" "),s("p",[t._v("选择《流控模式-关联》：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716102416266.png",alt:"image-20210716102416266"}})]),t._v(" "),s("p",[t._v("可以看到1000个用户，100秒，因此QPS为10，超过了我们设定的阈值：5")]),t._v(" "),s("p",[t._v("查看http请求：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716102532554.png",alt:"image-20210716102532554"}})]),t._v(" "),s("p",[t._v("请求的目标是/order/update，这样这个断点就会触发阈值。")]),t._v(" "),s("p",[t._v("但限流的目标是/order/query，我们在浏览器访问，可以发现：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716102636030.png",alt:"image-20210716102636030"}})]),t._v(" "),s("p",[t._v("确实被限流了。")]),t._v(" "),s("p",[t._v("5）总结")]),t._v(" "),s("p",[s("strong",[t._v("当优先级高的服务触发阈值时，对优先级低的服务进行限制")])]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716103143002.png",alt:"image-20210716103143002"}})]),t._v(" "),s("h3",{attrs:{id:"链路模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#链路模式"}},[t._v("#")]),t._v(" 链路模式")]),t._v(" "),s("p",[s("strong",[t._v("链路模式")]),t._v("：只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值。")]),t._v(" "),s("p",[s("strong",[t._v("配置示例")]),t._v("：")]),t._v(" "),s("p",[t._v("例如有两条请求链路：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("/test1 --\x3e /common")])]),t._v(" "),s("li",[s("p",[t._v("/test2 --\x3e /common")])])]),t._v(" "),s("p",[t._v("如果只希望统计从/test2进入到/common的请求，则可以这样配置：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716103536346.png",alt:"image-20210716103536346"}})]),t._v(" "),s("p",[s("strong",[t._v("实战案例")])]),t._v(" "),s("p",[t._v("需求：有查询订单和创建订单业务，两者都需要查询商品。针对从查询订单进入到查询商品的请求统计，并设置限流。")]),t._v(" "),s("p",[t._v("步骤：")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("在OrderService中添加一个queryGoods方法，不用实现业务")])]),t._v(" "),s("li",[s("p",[t._v("在OrderController中，改造/order/query端点，调用OrderService中的queryGoods方法")])]),t._v(" "),s("li",[s("p",[t._v("在OrderController中添加一个/order/save的端点，调用OrderService的queryGoods方法")])]),t._v(" "),s("li",[s("p",[t._v("给queryGoods设置限流规则，从/order/query进入queryGoods的方法限制QPS必须小于2")])])]),t._v(" "),s("p",[t._v("实现：")]),t._v(" "),s("h4",{attrs:{id:"_1-添加查询商品方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-添加查询商品方法"}},[t._v("#")]),t._v(" 1）添加查询商品方法")]),t._v(" "),s("p",[t._v("在order-service服务中，给OrderService类添加一个queryGoods方法：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("queryGoods")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"查询商品"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"_2-查询订单时-查询商品"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-查询订单时-查询商品"}},[t._v("#")]),t._v(" 2）查询订单时，查询商品")]),t._v(" "),s("p",[t._v("在order-service的OrderController中，修改/order/query端点的业务逻辑：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@GetMapping")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/query"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("queryOrder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 查询商品")]),t._v("\n    orderService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("queryGoods")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 查询订单")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"查询订单"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"查询订单成功"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"_3-新增订单-查询商品"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-新增订单-查询商品"}},[t._v("#")]),t._v(" 3）新增订单，查询商品")]),t._v(" "),s("p",[t._v("在order-service的OrderController中，修改/order/save端点，模拟新增订单：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@GetMapping")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/save"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("saveOrder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 查询商品")]),t._v("\n    orderService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("queryGoods")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 查询订单")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"新增订单"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"新增订单成功"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"_4-给查询商品添加资源标记"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-给查询商品添加资源标记"}},[t._v("#")]),t._v(" 4）给查询商品添加资源标记")]),t._v(" "),s("p",[t._v("默认情况下，OrderService中的方法是不被Sentinel监控的，需要我们自己通过注解来标记要监控的方法。")]),t._v(" "),s("p",[t._v("给OrderService的queryGoods方法添加@SentinelResource注解：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@SentinelResource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"goods"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("queryGoods")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"查询商品"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[s("strong",[t._v("链路模式中，是对不同来源的两个链路做监控。但是sentinel默认会给进入SpringMVC的所有请求设置同一个root资源，会导致链路模式失效。")])]),t._v(" "),s("p",[t._v("我们需要关闭这种对SpringMVC的资源聚合，修改order-service服务的application.yml文件：")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spring")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cloud")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sentinel")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("web-context-unify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 关闭context整合")]),t._v("\n")])])]),s("p",[t._v("重启服务，访问/order/query和/order/save，可以查看到sentinel的簇点链路规则中，出现了新的资源：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716105227163.png",alt:"image-20210716105227163"}})]),t._v(" "),s("h4",{attrs:{id:"_5-添加流控规则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-添加流控规则"}},[t._v("#")]),t._v(" 5）添加流控规则")]),t._v(" "),s("p",[t._v("点击goods资源后面的流控按钮，在弹出的表单中填写下面信息：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716105408723.png",alt:"image-20210716105408723"}})]),t._v(" "),s("p",[t._v("只统计从/order/query进入/goods的资源，QPS阈值为2，超出则被限流。")]),t._v(" "),s("h4",{attrs:{id:"_6-jmeter测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-jmeter测试"}},[t._v("#")]),t._v(" 6）Jmeter测试")]),t._v(" "),s("p",[t._v("选择《流控模式-链路》：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716105612312.png",alt:"image-20210716105612312"}})]),t._v(" "),s("p",[t._v("可以看到这里200个用户，50秒内发完，QPS为4，超过了我们设定的阈值2")]),t._v(" "),s("p",[t._v("一个http请求是访问/order/save：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716105812789.png",alt:"image-20210716105812789"}})]),t._v(" "),s("p",[t._v("运行的结果：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716110027064.png",alt:"image-20210716110027064"}})]),t._v(" "),s("p",[t._v("完全不受影响。")]),t._v(" "),s("p",[t._v("另一个是访问/order/query：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716105855951.png",alt:"image-20210716105855951"}})]),t._v(" "),s("p",[t._v("运行结果：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716105956401.png",alt:"image-20210716105956401"}})]),t._v(" "),s("p",[t._v("每次只有2个通过。")]),t._v(" "),s("h3",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" "),s("strong",[t._v("总结")])]),t._v(" "),s("p",[t._v("流控模式有哪些？")]),t._v(" "),s("p",[t._v("•直接：对当前资源限流")]),t._v(" "),s("p",[t._v("•关联：高优先级资源触发阈值，对低优先级资源限流。")]),t._v(" "),s("p",[t._v("•链路：阈值统计时，只统计从指定资源进入当前资源的请求，是对请求来源的限流")]),t._v(" "),s("h2",{attrs:{id:"流控效果"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#流控效果"}},[t._v("#")]),t._v(" 流控效果")]),t._v(" "),s("p",[t._v("在流控的高级选项中，还有一个流控效果选项：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716110225104.png",alt:"image-20210716110225104"}})]),t._v(" "),s("p",[t._v("流控效果是指请求达到流控阈值时应该采取的措施，包括三种：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("快速失败：达到阈值后，新的请求会被立即拒绝并抛出FlowException异常。是默认的处理方式。")])]),t._v(" "),s("li",[s("p",[t._v("warm up：预热模式，对超出阈值的请求同样是拒绝并抛出异常。但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值。")])]),t._v(" "),s("li",[s("p",[t._v("排队等待：让所有的请求按照先后次序排队执行，两个请求的间隔不能大于指定时长")])])]),t._v(" "),s("h3",{attrs:{id:"warm-up"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#warm-up"}},[t._v("#")]),t._v(" warm up")]),t._v(" "),s("p",[t._v("阈值一般是一个微服务能承担的最大QPS，但是一个服务刚刚启动时，一切资源尚未初始化（"),s("strong",[t._v("冷启动")]),t._v("），如果直接将QPS跑到最大值，可能导致服务瞬间宕机。")]),t._v(" "),s("p",[t._v("warm up也叫"),s("strong",[t._v("预热模式")]),t._v("，是应对服务冷启动的一种方案。请求阈值初始值是 maxThreshold / coldFactor，持续指定时长后，逐渐提高到maxThreshold值。"),s("strong",[t._v("而coldFactor的默认值是3.")])]),t._v(" "),s("p",[t._v("例如，我设置QPS的maxThreshold为10，预热时间为5秒，那么初始阈值就是 10 / 3 ，也就是3，然后在5秒后逐渐增长到10.")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716110629796.png",alt:"image-20210716110629796"}})]),t._v(" "),s("p",[s("strong",[t._v("案例")])]),t._v(" "),s("p",[t._v("需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用warm up效果，预热时长为5秒")]),t._v(" "),s("h4",{attrs:{id:"_1-配置流控规则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-配置流控规则"}},[t._v("#")]),t._v(" 1）配置流控规则：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716111012387.png",alt:"image-20210716111012387"}})]),t._v(" "),s("h4",{attrs:{id:"_2-jmeter测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-jmeter测试"}},[t._v("#")]),t._v(" 2）Jmeter测试")]),t._v(" "),s("p",[t._v("选择《流控效果，warm up》：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716111136699.png",alt:"image-20210716111136699"}})]),t._v(" "),s("p",[t._v("QPS为10.")]),t._v(" "),s("p",[t._v("刚刚启动时，大部分请求失败，成功的只有3个，说明QPS被限定在3：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716111303701.png",alt:"image-20210716111303701"}})]),t._v(" "),s("p",[t._v("随着时间推移，成功比例越来越高：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716111404717.png",alt:"image-20210716111404717"}})]),t._v(" "),s("p",[t._v("到Sentinel控制台查看实时监控：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716111526480.png",alt:"image-20210716111526480"}})]),t._v(" "),s("p",[t._v("一段时间后：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716111658541.png",alt:"image-20210716111658541"}})]),t._v(" "),s("h3",{attrs:{id:"排队等待"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#排队等待"}},[t._v("#")]),t._v(" 排队等待")]),t._v(" "),s("p",[t._v("当请求超过QPS阈值时，快速失败和warm up 会拒绝新的请求并抛出异常。")]),t._v(" "),s("p",[t._v("而排队等待则是让所有请求进入一个队列中，然后按照阈值允许的时间间隔依次执行。"),s("strong",[t._v("后来的请求必须等待前面执行完成，如果请求预期的等待时间超出最大时长，则会被拒绝。")])]),t._v(" "),s("p",[t._v("工作原理")]),t._v(" "),s("p",[t._v("例如：QPS = 5，意味着每200ms处理一个队列中的请求；timeout = 2000，意味着"),s("strong",[t._v("预期等待时长")]),t._v("超过2000ms的请求会被拒绝并抛出异常。")]),t._v(" "),s("p",[t._v("那什么叫做预期等待时长呢？")]),t._v(" "),s("p",[t._v("比如现在一下子来了12 个请求，因为每200ms执行一个请求，那么：")]),t._v(" "),s("ul",[s("li",[t._v("第6个请求的"),s("strong",[t._v("预期等待时长")]),t._v(" =  200 * （6 - 1） = 1000ms")]),t._v(" "),s("li",[t._v("第12个请求的预期等待时长 = 200 * （12-1） = 2200ms")])]),t._v(" "),s("p",[t._v("现在，第1秒同时接收到10个请求，但第2秒只有1个请求，此时QPS的曲线这样的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716113147176.png",alt:"image-20210716113147176"}})]),t._v(" "),s("p",[t._v("如果使用队列模式做流控，所有进入的请求都要排队，以固定的200ms的间隔执行，QPS会变的很平滑：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716113426524.png",alt:"image-20210716113426524"}})]),t._v(" "),s("p",[t._v("平滑的QPS曲线，对于服务器来说是更友好的。")]),t._v(" "),s("p",[s("strong",[t._v("案例")])]),t._v(" "),s("p",[t._v("需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用排队的流控效果，超时时长设置为5s")]),t._v(" "),s("h4",{attrs:{id:"_1-添加流控规则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-添加流控规则"}},[t._v("#")]),t._v(" 1）添加流控规则")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716114048918.png",alt:"image-20210716114048918"}})]),t._v(" "),s("h4",{attrs:{id:"_2-jmeter测试-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-jmeter测试-2"}},[t._v("#")]),t._v(" 2）Jmeter测试")]),t._v(" "),s("p",[t._v("选择《流控效果，队列》：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716114243558.png",alt:"image-20210716114243558"}})]),t._v(" "),s("p",[t._v("QPS为15，已经超过了我们设定的10。")]),t._v(" "),s("p",[t._v("如果是之前的 快速失败、warmup模式，超出的请求应该会直接报错。")]),t._v(" "),s("p",[t._v("但是我们看看队列模式的运行结果：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716114429361.png",alt:"image-20210716114429361"}})]),t._v(" "),s("p",[t._v("全部都通过了。")]),t._v(" "),s("p",[t._v("再去sentinel查看实时监控的QPS曲线：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716114522935.png",alt:"image-20210716114522935"}})]),t._v(" "),s("p",[t._v("QPS非常平滑，一致保持在10，但是超出的请求没有被拒绝，而是放入队列。因此"),s("strong",[t._v("响应时间")]),t._v("（等待时间）会越来越长。")]),t._v(" "),s("p",[t._v("当队列满了以后，才会有部分请求失败：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716114651137.png",alt:"image-20210716114651137"}})]),t._v(" "),s("h3",{attrs:{id:"总结-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结-2"}},[t._v("#")]),t._v(" "),s("strong",[t._v("总结")])]),t._v(" "),s("p",[t._v("流控效果有哪些？")]),t._v(" "),s("ul",[s("li",[t._v("快速失败：QPS超过阈值时，拒绝新的请求")]),t._v(" "),s("li",[t._v("warm up： QPS超过阈值时，拒绝新的请求；QPS阈值是逐渐提升的，可以避免冷启动时高并发导致服务宕机。")]),t._v(" "),s("li",[t._v("排队等待：请求会进入队列，按照阈值允许的时间间隔依次执行请求；如果请求预期等待时长大于超时时间，直接拒绝\n"),s("ul",[s("li",[t._v("流量整形")])])])]),t._v(" "),s("h2",{attrs:{id:"热点参数限流"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#热点参数限流"}},[t._v("#")]),t._v(" 热点参数限流")]),t._v(" "),s("p",[t._v("之前的限流是统计访问某个资源的所有请求，判断是否超过QPS阈值。而热点参数限流是"),s("strong",[t._v("分别统计参数值相同的请求")]),t._v("，判断是否超过QPS阈值。")]),t._v(" "),s("p",[s("strong",[t._v("更细粒度的限流")])]),t._v(" "),s("h3",{attrs:{id:"全局参数限流"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#全局参数限流"}},[t._v("#")]),t._v(" 全局参数限流")]),t._v(" "),s("p",[t._v("例如，一个根据id查询商品的接口：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716115014663.png",alt:"image-20210716115014663"}})]),t._v(" "),s("p",[t._v("访问/goods/{id}的请求中，id参数值会有变化，热点参数限流会根据参数值分别统计QPS，统计结果：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716115131463.png",alt:"image-20210716115131463"}})]),t._v(" "),s("p",[t._v("当id=1的请求触发阈值被限流时，id值不为1的请求不受影响。")]),t._v(" "),s("p",[t._v("配置示例：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716115232426.png",alt:"image-20210716115232426"}})]),t._v(" "),s("p",[t._v("代表的含义是：对hot这个资源的0号参数（第一个参数）做统计，每1秒"),s("strong",[t._v("相同参数值")]),t._v("的请求数不能超过5")]),t._v(" "),s("h3",{attrs:{id:"热点参数限流-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#热点参数限流-2"}},[t._v("#")]),t._v(" 热点参数限流")]),t._v(" "),s("p",[t._v("刚才的配置中，对查询商品这个接口的所有商品一视同仁，QPS都限定为5.")]),t._v(" "),s("p",[t._v("而在实际开发中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的QPS限制与其它商品不一样，高一些。那就需要配置热点参数限流的高级选项了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716115717523.png",alt:"image-20210716115717523"}})]),t._v(" "),s("p",[t._v("结合上一个配置，这里的含义是对0号的long类型参数限流，每1秒相同参数的QPS不能超过5，有两个例外：")]),t._v(" "),s("p",[t._v("•如果参数值是100，则每1秒允许的QPS为10")]),t._v(" "),s("p",[t._v("•如果参数值是101，则每1秒允许的QPS为15")]),t._v(" "),s("h3",{attrs:{id:"案例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例"}},[t._v("#")]),t._v(" 案例")]),t._v(" "),s("p",[s("strong",[t._v("案例需求")]),t._v("：给/order/{orderId}这个资源添加热点参数限流，规则如下：")]),t._v(" "),s("p",[t._v("•默认的热点参数规则是每1秒请求量不超过2")]),t._v(" "),s("p",[t._v("•给102这个参数设置例外：每1秒请求量不超过4")]),t._v(" "),s("p",[t._v("•给103这个参数设置例外：每1秒请求量不超过10")]),t._v(" "),s("p",[s("strong",[t._v("注意事项")]),t._v("：热点参数限流对默认的SpringMVC资源无效，需要利用@SentinelResource注解标记资源")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("即  只能对使用注解标记的资源进行热点参数限流。")])])]),t._v(" "),s("h4",{attrs:{id:"_1-标记资源"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-标记资源"}},[t._v("#")]),t._v(" 1）标记资源")]),t._v(" "),s("p",[t._v("给order-service中的OrderController中的/order/{orderId}资源添加注解：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716120033572.png",alt:"image-20210716120033572"}})]),t._v(" "),s("h4",{attrs:{id:"_2-热点参数限流规则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-热点参数限流规则"}},[t._v("#")]),t._v(" 2）热点参数限流规则")]),t._v(" "),s("p",[t._v("访问该接口，可以看到我们标记的hot资源出现了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716120208509.png",alt:"image-20210716120208509"}})]),t._v(" "),s("p",[t._v("这里不要点击hot后面的按钮，页面有BUG")]),t._v(" "),s("p",[t._v("点击左侧菜单中"),s("strong",[t._v("热点规则")]),t._v("菜单：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716120319009.png",alt:"image-20210716120319009"}})]),t._v(" "),s("p",[t._v("点击新增，填写表单：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716120536714.png",alt:"image-20210716120536714"}})]),t._v(" "),s("h4",{attrs:{id:"_3-jmeter测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-jmeter测试"}},[t._v("#")]),t._v(" 3）Jmeter测试")]),t._v(" "),s("p",[t._v("选择《热点参数限流 QPS1》：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716120754527.png",alt:"image-20210716120754527"}})]),t._v(" "),s("p",[t._v("这里发起请求的QPS为5.")]),t._v(" "),s("p",[t._v("包含3个http请求：")]),t._v(" "),s("p",[t._v("普通参数，QPS阈值为2")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716120840501.png",alt:"image-20210716120840501"}})]),t._v(" "),s("p",[t._v("运行结果：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716121105567.png",alt:"image-20210716121105567"}})]),t._v(" "),s("p",[t._v("例外项，QPS阈值为4")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716120900365.png",alt:"image-20210716120900365"}})]),t._v(" "),s("p",[t._v("运行结果：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716121201630.png",alt:"image-20210716121201630"}})]),t._v(" "),s("p",[t._v("例外项，QPS阈值为10")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716120919131.png",alt:"image-20210716120919131"}})]),t._v(" "),s("p",[t._v("运行结果：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/assets/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%BF%9B%E9%98%B6/image-20210716121220305.png",alt:"image-20210716121220305"}})])])}),[],!1,null,null,null);s.default=e.exports}}]);